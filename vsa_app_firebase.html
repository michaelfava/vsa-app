<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon VSA Audit System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Amazon Ember',Arial,sans-serif;background:linear-gradient(135deg,#232F3E 0%,#131A22 100%);color:#fff;min-height:100vh}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .page{display:none}.page.active{display:block}

        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh}
        .login-box{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;width:100%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
        .logo{text-align:center;margin-bottom:30px}
        .logo h1{color:#FF9900;font-size:32px;margin-bottom:10px}
        .logo p{color:#ccc;font-size:14px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;color:#ddd;font-size:14px}
        .form-group input{width:100%;padding:12px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:16px;transition:all 0.3s}
        .form-group input:focus{outline:none;border-color:#FF9900;background:rgba(255,255,255,0.15)}

        .btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;text-transform:uppercase}
        .btn-primary{background:#FF9900;color:#131A22}
        .btn-primary:hover{background:#FFB84D;transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,153,0,0.4)}
        .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
        .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
        .btn-secondary{background:#6c757d;color:#fff}.btn-secondary:hover{background:#5a6268}
        .btn-info{background:#17a2b8;color:#fff}.btn-info:hover{background:#138496}

        .header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:20px;border-radius:15px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
        .header h2{color:#FF9900;font-size:24px}
        .header-actions{display:flex;gap:10px;flex-wrap:wrap}
        .header-actions button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s}

        .upload-section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:30px;margin-bottom:20px}
        .upload-section h3{color:#FF9900;margin-bottom:20px;font-size:20px}
        .file-input-wrapper{position:relative;margin-bottom:15px}
        .file-input-wrapper input[type="file"]{display:none}
        .file-input-label{display:block;padding:15px;background:rgba(255,255,255,0.05);border:2px dashed rgba(255,255,255,0.3);border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s}
        .file-input-label:hover{border-color:#FF9900;background:rgba(255,255,255,0.1)}
        .file-name{color:#28a745;margin-top:5px;font-size:14px}

        .status-message{padding:15px;border-radius:8px;margin-top:20px;font-size:14px}
        .status-success{background:rgba(40,167,69,0.2);border:1px solid #28a745;color:#28a745}
        .status-error{background:rgba(220,53,69,0.2);border:1px solid #dc3545;color:#dc3545}
        .status-info{background:rgba(255,153,0,0.2);border:1px solid #FF9900;color:#FF9900}

        .autocomplete-wrapper{position:relative;z-index:10000}
        #autocomplete-list{position:absolute;top:100%;left:0;right:0;background:#232F3E;border:2px solid #FF9900;border-top:none;border-radius:0 0 8px 8px;max-height:400px;overflow-y:auto;z-index:10000;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
        .autocomplete-item{padding:12px 15px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.2s}
        .autocomplete-item:hover{background:rgba(255,153,0,0.2)}
        .autocomplete-item strong{color:#FF9900}

        /* Audit page */
        #audit-page .container{padding:0}
        #audit-page .header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:12px 16px;border-radius:0 0 14px 14px;margin-bottom:0;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:nowrap}
        #audit-page .header h2{font-size:18px;margin:0;color:#FF9900;white-space:nowrap}
        #audit-page .header-actions{display:flex;gap:6px;flex-wrap:nowrap}
        #audit-page .header-actions button{padding:6px 10px;font-size:12px}

        .audit-search-bar{background:rgba(255,255,255,0.08);padding:12px 14px;display:flex;gap:8px;align-items:center}
        .audit-search-bar .autocomplete-wrapper{flex:1;min-width:0}
        .audit-search-bar #license-plate-input{width:100%;padding:12px 14px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:17px;text-transform:uppercase;box-sizing:border-box}
        .audit-search-bar #license-plate-input:focus{outline:none;border-color:#FF9900}
        .audit-search-bar .btn-check{flex-shrink:0;padding:12px 16px;background:#FF9900;color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;white-space:nowrap;-webkit-tap-highlight-color:transparent}
        .audit-body{padding:12px 14px 24px}

        /* Add-vehicle card */
        .add-vehicle-card{background:rgba(255,153,0,0.08);border:2px solid #FF9900;border-radius:14px;padding:18px;display:none}
        .add-vehicle-card.show{display:block}
        .add-vehicle-card h3{color:#FF9900;margin:0 0 12px;font-size:16px}
        .add-vehicle-card .add-field{margin-bottom:12px}
        .add-vehicle-card .add-field label{display:block;color:#aaa;font-size:13px;margin-bottom:4px;font-weight:bold}
        .add-vehicle-card .add-field input{width:100%;padding:10px 12px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:15px;outline:none}
        .add-vehicle-card .add-field input:focus{border-color:#FF9900}
        .add-vehicle-card .add-btns{display:flex;gap:10px}
        .add-vehicle-card .add-btns button{flex:1;padding:12px;border:none;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer}
        .btn-add-save{background:#FF9900;color:#131A22}
        .btn-add-cancel{background:rgba(255,255,255,0.1);color:#aaa;border:1px solid rgba(255,255,255,0.15)!important}

        /* QR overlay ‚Äî full screen, main audit interaction */
        .qr-overlay{position:fixed;inset:0;z-index:20000;background:#131A22;display:none;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .qr-overlay.show{display:flex}
        .qr-overlay-top{background:rgba(255,255,255,0.06);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
        .qr-overlay-top .qr-back-btn{padding:8px 18px;background:rgba(255,255,255,0.1);color:#aaa;border:1px solid rgba(255,255,255,0.15);border-radius:8px;font-size:14px;cursor:pointer;-webkit-tap-highlight-color:transparent}
        .qr-overlay-top .qr-back-btn:hover{color:#fff;border-color:rgba(255,255,255,0.3)}
        .qr-overlay-top .qr-plate-title{font-size:20px;font-weight:bold;color:#FF9900}
        .qr-overlay-body{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 20px 32px;gap:14px}

        .qr-grounded-banner{width:100%;max-width:360px;background:rgba(220,53,69,0.2);border:3px solid #dc3545;border-radius:12px;padding:12px;text-align:center;animation:pulseGroundedWarning 1.5s ease-in-out infinite;display:none}
        .qr-grounded-banner.show{display:block}
        .qr-grounded-banner span{font-size:18px;font-weight:bold;color:#dc3545}

        .qr-code-wrap{background:#fff;border-radius:16px;padding:20px;display:inline-block;transition:all 0.3s}
        .qr-code-wrap.shrunk{display:none}
        .qr-audit-status{width:100%;max-width:360px;border-radius:12px;padding:10px 16px;text-align:center;font-size:15px;font-weight:bold}
        .qr-audit-status.todo{background:rgba(255,153,0,0.15);border:2px solid #FF9900;color:#FF9900}
        .qr-audit-status.done{background:rgba(40,167,69,0.15);border:2px solid #28a745;color:#28a745}
        #qr-code{display:inline-block}
        .qr-vehicle-info{color:#aaa;font-size:14px;text-align:center;line-height:1.6}
        .qr-vehicle-info strong{color:#fff}
        .qr-vehicle-info .qr-vin{font-family:monospace;font-size:13px;color:#FF9900;word-break:break-all}

        .qr-decision-area{width:100%;max-width:360px;display:flex;flex-direction:column;gap:10px;margin-top:6px}
        .qr-decision-row{display:flex;gap:12px}
        .qr-decision-row button{flex:1;padding:18px 10px;font-size:18px;font-weight:bold;border:none;border-radius:14px;cursor:pointer;text-transform:uppercase;color:#fff;-webkit-tap-highlight-color:transparent}
        .btn-van-ok{background:linear-gradient(135deg,#28a745,#20c997);box-shadow:0 4px 15px rgba(40,167,69,0.4)}
        .btn-vsa-block{background:linear-gradient(135deg,#dc3545,#c82333);box-shadow:0 4px 15px rgba(220,53,69,0.4)}

        .qr-problem-area{width:100%;max-width:360px;display:none}
        .qr-problem-area.show{display:block}
        .qr-problem-area h3{color:#dc3545;font-size:15px;margin-bottom:8px}
        .qr-problem-area textarea{width:100%;min-height:80px;padding:12px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:16px;resize:vertical;outline:none;box-sizing:border-box}
        .qr-problem-area textarea:focus{border-color:#dc3545}
        .qr-problem-area .btn-submit-block{margin-top:10px;width:100%;padding:16px;background:#dc3545;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer}

        .qr-saved-msg{width:100%;max-width:360px;background:rgba(40,167,69,0.15);border:2px solid #28a745;border-radius:12px;padding:16px;text-align:center;display:none;animation:fadeInUp 0.3s ease}
        .qr-saved-msg.show{display:block}
        .qr-saved-msg span{font-size:18px;font-weight:bold;color:#28a745}

        @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulseGlow{0%,100%{box-shadow:0 0 10px rgba(255,193,7,0.5)}50%{box-shadow:0 0 20px rgba(255,193,7,0.8)}}
        @keyframes pulseGroundedWarning{0%,100%{box-shadow:0 0 15px rgba(220,53,69,0.6)}50%{box-shadow:0 0 30px rgba(220,53,69,1)}}

        .status-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:bold;color:#fff}
        .badge-active{background:#28a745}.badge-grounded{background:#dc3545}

        .download-section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:30px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s}
        .stat-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(255,153,0,0.3)}
        .stat-value{font-size:36px;font-weight:bold;color:#FF9900;margin-bottom:5px}
        .stat-label{color:#aaa;font-size:14px}
        .download-buttons{display:flex;gap:15px;flex-wrap:wrap;margin-top:20px}
        .download-buttons button{flex:1;min-width:200px}

        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-overlay.show{display:flex}
        .spinner{border:4px solid rgba(255,255,255,0.1);border-top:4px solid #FF9900;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .loading-text{position:absolute;margin-top:100px;color:#FF9900;font-size:16px}

        @media(max-width:768px){
            .container{padding:10px}
            .header{flex-direction:column;align-items:stretch}
            .header-actions{flex-direction:column}
            .header-actions button{width:100%}
            #audit-page .header{flex-direction:row;align-items:center}
            #audit-page .header-actions{flex-direction:row}
            #audit-page .header-actions button{width:auto}
            #audit-page .container{padding:0}
            .download-buttons{flex-direction:column}
            .download-buttons button{width:100%}
            .stats-grid{grid-template-columns:1fr}
        }

        .hidden{display:none!important}
        .firebase-status{background:rgba(66,133,244,0.1);border:1px solid #4285f4;border-radius:8px;padding:15px;margin-bottom:20px}
        .firebase-status.connected{background:rgba(40,167,69,0.1);border-color:#28a745}
        .firebase-status.error{background:rgba(220,53,69,0.1);border-color:#dc3545}

        .collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;padding:5px 0;margin-bottom:15px}
        .collapsible-header:hover{opacity:0.8}
        .collapse-icon{font-size:20px;transition:transform 0.3s}
        .collapse-icon.collapsed{transform:rotate(-90deg)}
        .collapsible-content{max-height:2000px;overflow:hidden;transition:max-height 0.3s ease-out,opacity 0.3s ease-out;opacity:1}
        .collapsible-content.hidden{max-height:0;opacity:0}

        .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);overflow:auto}
        .modal.show{display:flex;justify-content:center;align-items:center;padding:20px}
        .modal-content{background:#232F3E;border-radius:15px;padding:30px;max-width:1200px;width:100%;max-height:80vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #FF9900;padding-bottom:15px}
        .modal-header h2{color:#FF9900;margin:0}
        .modal-close{background:#dc3545;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold}
        .modal-close:hover{background:#c82333}
        .data-table{width:100%;border-collapse:collapse;margin-top:20px}
        .data-table th{background:rgba(255,153,0,0.2);color:#FF9900;padding:12px;text-align:left;font-weight:bold;border-bottom:2px solid #FF9900;cursor:pointer;user-select:none;white-space:nowrap}
        .data-table th:hover{color:#fff;background:rgba(255,153,0,0.3)}
        .data-table th .sort-arrow{display:inline-block;margin-left:4px;font-size:10px;opacity:0.4}
        .data-table th.active-sort .sort-arrow{opacity:1;color:#FF9900}
        .data-table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.1);color:#fff}
        .data-table tr:hover{background:rgba(255,153,0,0.1)}
        .status-badge-table{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:bold}
        .badge-active-table{background:#28a745;color:#fff}.badge-grounded-table{background:#dc3545;color:#fff}
        .badge-passed-table{background:#28a745;color:#fff}.badge-failed-table{background:#dc3545;color:#fff}
        .modal-actions{margin-top:20px;display:flex;gap:15px}
        .empty-data{text-align:center;padding:40px;color:#aaa;font-size:18px}

        .modal-toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px;align-items:center;padding:14px 16px;background:rgba(255,255,255,0.04);border-radius:10px;border:1px solid rgba(255,255,255,0.08)}
        .modal-toolbar input{background:#1a2332;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:6px;padding:7px 10px;font-size:13px;outline:none}
        .modal-toolbar input:focus{border-color:#FF9900}
        .modal-toolbar input::placeholder{color:#667}
        .toolbar-label{color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
        .toolbar-group{display:flex;align-items:center;gap:5px}
        .modal-toolbar .search-input{flex:1;min-width:140px;max-width:220px}
        .modal-count{color:#FF9900;font-size:13px;font-weight:bold;margin-left:auto;white-space:nowrap}

        .ms-wrap{display:flex;flex-wrap:wrap;gap:5px}
        .ms-pill{background:#1a2332;color:#aaa;border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:5px 11px;font-size:12px;cursor:pointer;transition:background 0.15s,color 0.15s,border-color 0.15s;-webkit-tap-highlight-color:transparent;user-select:none;outline:none}
        .ms-pill:hover{border-color:rgba(255,153,0,0.4);color:#fff}
        .ms-pill.on{background:rgba(255,153,0,0.18);border-color:#FF9900;color:#FF9900;font-weight:600}

        .progress-section{background:linear-gradient(135deg,rgba(255,153,0,0.07) 0%,rgba(34,45,60,0.6) 100%);border:1px solid rgba(255,153,0,0.25);border-radius:14px;padding:24px 26px;margin-top:28px;margin-bottom:8px}
        .progress-section h3{margin:0 0 4px;color:#FF9900;font-size:18px}
        .progress-week-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:6px}
        .progress-week-badge{background:rgba(255,153,0,0.15);color:#FF9900;border:1px solid rgba(255,153,0,0.3);border-radius:20px;padding:4px 14px;font-size:13px;font-weight:600}
        .progress-target-badge{font-size:13px;color:#aaa}
        .progress-target-badge strong{color:#fff}
        .progress-bar-wrap{position:relative;margin-bottom:22px;padding-top:20px}
        .progress-bar-track{position:relative;height:28px;background:rgba(255,255,255,0.06);border-radius:14px;overflow:visible}
        .progress-bar-fill{height:100%;border-radius:14px;transition:width 0.6s ease,background 0.4s;display:flex;align-items:center;justify-content:flex-end;padding-right:12px;font-size:14px;font-weight:bold;color:#fff;white-space:nowrap;min-width:46px;text-shadow:0 1px 3px rgba(0,0,0,0.4)}
        .progress-bar-fill.met{background:linear-gradient(90deg,#28a745,#34ce57)}
        .progress-bar-fill.not-met{background:linear-gradient(90deg,#FF9900,#ffb03a)}
        .progress-target-marker{position:absolute;top:-20px;width:2px;height:calc(100% + 20px);background:rgba(255,255,255,0.55);border-radius:1px;pointer-events:none;z-index:2}
        .progress-target-marker::before{content:attr(data-label);position:absolute;top:0;left:50%;transform:translateX(-50%);font-size:11px;color:#ccc;white-space:nowrap;font-weight:600}
        .progress-numbers{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
        .progress-num-card{background:rgba(255,255,255,0.04);border-radius:10px;padding:14px 12px;text-align:center;border:1px solid rgba(255,255,255,0.06)}
        .progress-num-card.highlight-needed{border-color:rgba(255,153,0,0.4);background:rgba(255,153,0,0.08)}
        .progress-num-card.highlight-needed.zero{border-color:rgba(40,167,69,0.4);background:rgba(40,167,69,0.08)}
        .progress-num-value{font-size:26px;font-weight:bold;color:#FF9900;line-height:1.1}
        .progress-num-card.highlight-needed .progress-num-value{color:#FF9900}
        .progress-num-card.highlight-needed.zero .progress-num-value{color:#28a745}
        .progress-num-label{color:#aaa;font-size:12px;margin-top:4px;line-height:1.3}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay"><div><div class="spinner"></div><div class="loading-text" id="loading-text">Processing...</div></div></div>

    <!-- LOGIN -->
    <div class="page active" id="login-page">
        <div class="login-container"><div class="login-box">
            <div class="logo"><h1>üöê VSA Audit</h1><p>Vehicle Safety Audit System</p><p style="font-size:12px;margin-top:10px;color:#FF9900;">Multi-User Cloud Database</p></div>
            <form id="login-form">
                <div class="form-group"><label for="username">Email</label><input type="email" id="username" required autocomplete="email" placeholder="user@example.com"></div>
                <div class="form-group"><label for="password">Password</label><input type="password" id="password" required autocomplete="current-password"></div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <div id="login-error" class="status-message status-error hidden" style="margin-top:15px;">Invalid credentials</div>
        </div></div>
    </div>

    <!-- UPLOAD / DATA MANAGEMENT -->
    <div class="page" id="upload-page"><div class="container">
        <div class="header"><h2>üìÅ Data Management</h2>
            <div class="header-actions">
                <button onclick="showPage('audit-page')" class="btn-primary">Go to Audit</button>
                <button onclick="showPage('download-page')" class="btn-secondary">View Reports</button>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>
        </div>
        <div id="firebase-status-section" class="upload-section" style="display:none;">
            <div class="collapsible-header" onclick="toggleSection('firebase-status')"><h3>üîó Connection Status</h3><span class="collapse-icon" id="firebase-status-icon">‚ñº</span></div>
            <div id="firebase-status-content" class="collapsible-content">
                <div id="firebase-status" class="firebase-status"><div style="display:flex;align-items:center;gap:10px;"><span id="firebase-icon" style="font-size:24px;">üî¥</span><div><div id="firebase-text" style="font-weight:bold;"></div><div id="firebase-detail" style="font-size:12px;margin-top:5px;"></div></div></div></div>
            </div>
        </div>
        <div class="upload-section">
            <div class="collapsible-header" onclick="toggleSection('upload-files')"><h3>üìä Upload Data Files</h3><span class="collapse-icon collapsed" id="upload-files-icon">‚ñº</span></div>
            <div id="upload-files-content" class="collapsible-content hidden">
                <p style="color:#aaa;margin-bottom:20px;">Upload files to update the shared database (all users will see changes)</p>
                <div class="file-input-wrapper"><input type="file" id="dive-deep-file" accept=".csv" onchange="handleFileSelect(this,'dive-deep')"><label for="dive-deep-file" class="file-input-label">üìÑ Click to select Expected Vehicles (Active) CSV<div class="file-name" id="dive-deep-name"></div></label></div>
                <div class="file-input-wrapper"><input type="file" id="vin-audit-file" accept=".xlsx" onchange="handleFileSelect(this,'vin-audit')"><label for="vin-audit-file" class="file-input-label">üìã Click to select VIN Audit Detail XLSX<div class="file-name" id="vin-audit-name"></div></label></div>
                <div class="file-input-wrapper"><input type="file" id="grounded-file" accept=".xlsx" onchange="handleFileSelect(this,'grounded')"><label for="grounded-file" class="file-input-label">üö´ Click to select Current Grounded Vehicle XLSX<div class="file-name" id="grounded-name"></div></label></div>
                <button onclick="processFiles()" class="btn btn-primary" style="margin-top:20px;">Process & Upload to Cloud</button>
                <div id="upload-status"></div>
            </div>
        </div>
        <div class="upload-section">
            <h3>üìà Current Database Status</h3>
            <p style="color:#aaa;margin-bottom:15px;font-size:13px;">Click any card to view details</p>
            <div class="stats-grid">
                <div class="stat-card" onclick="viewVehicleData('active')"><div class="stat-value" id="total-vehicles">0</div><div class="stat-label">Active Vehicles</div></div>
                <div class="stat-card" onclick="viewVehicleData('grounded')"><div class="stat-value" id="grounded-count">0</div><div class="stat-label">Grounded Vehicles</div></div>
                <div class="stat-card" onclick="viewVehicleData('audited')"><div class="stat-value" id="audited-count">0</div><div class="stat-label">Already Audited</div></div>
                <div class="stat-card" style="border:2px solid #FF9900;background:rgba(255,153,0,0.08);" onclick="viewVehicleData('to-audit')"><div class="stat-value" id="to-audit-count" style="color:#FF9900;">0</div><div class="stat-label" style="color:#FF9900;font-weight:bold;">üöê To Be Audited</div></div>
            </div>
            <div class="progress-section">
                <h3>üìä Audit Progress</h3>
                <div class="progress-week-row">
                    <span class="progress-week-badge" id="progress-week-badge">Week ‚Äî</span>
                    <span class="progress-target-badge" id="progress-target-badge">Target: <strong>70%</strong></span>
                </div>
                <div class="progress-bar-wrap"><div class="progress-bar-track">
                    <div class="progress-bar-fill not-met" id="progress-fill" style="width:0%">0%</div>
                    <div class="progress-target-marker" id="progress-target-marker" style="left:70%" data-label="Target 70%"></div>
                </div></div>
                <div class="progress-numbers">
                    <div class="progress-num-card"><div class="progress-num-value" id="prog-current-pct">0%</div><div class="progress-num-label">Current %</div></div>
                    <div class="progress-num-card"><div class="progress-num-value" id="prog-target-pct">70%</div><div class="progress-num-label">Target %</div></div>
                    <div class="progress-num-card"><div class="progress-num-value" id="prog-audited">0</div><div class="progress-num-label">Audited</div></div>
                    <div class="progress-num-card"><div class="progress-num-value" id="prog-total">0</div><div class="progress-num-label">Total to Audit</div></div>
                    <div class="progress-num-card highlight-needed" id="prog-needed-card"><div class="progress-num-value" id="prog-needed">0</div><div class="progress-num-label">Still needed<br>to reach target</div></div>
                </div>
            </div>
            <h3 style="margin-top:30px;">üóëÔ∏è Database Management</h3>
            <p style="color:#aaa;margin-bottom:20px;">Clear databases to start fresh (affects all users)</p>
            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                <button onclick="clearVehicleDatabase()" class="btn btn-danger" style="flex:1;min-width:200px;">üóëÔ∏è Clear Vehicle Database</button>
                <button onclick="clearAuditDatabase()" class="btn btn-danger" style="flex:1;min-width:200px;">üóëÔ∏è Clear Audit Database</button>
                <button onclick="clearAllDatabases()" class="btn btn-danger" style="flex:1;min-width:200px;">‚ö†Ô∏è Clear Everything</button>
            </div>
            <div id="clear-status"></div>
        </div>
    </div></div>

    <!-- AUDIT PAGE -->
    <div class="page" id="audit-page"><div class="container">
        <div class="header"><h2>üîç VSA Audit</h2>
            <div class="header-actions">
                <button onclick="showPage('upload-page')" class="btn-secondary">Data</button>
                <button onclick="showPage('download-page')" class="btn-secondary">Reports</button>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>
        </div>
        <div class="audit-search-bar">
            <div class="autocomplete-wrapper">
                <input type="text" id="license-plate-input" placeholder="e.g. HB449JJ" autocomplete="off" inputmode="text">
                <div id="autocomplete-list"></div>
            </div>
            <button onclick="searchVehicle()" class="btn-check">üîç</button>
        </div>
        <div class="audit-body">
            <div class="add-vehicle-card" id="add-vehicle-card">
                <h3>‚ûï Vehicle not found ‚Äî Add to database</h3>
                <div class="add-field"><label>License Plate</label><input type="text" id="add-plate" readonly style="opacity:0.7;"></div>
                <div class="add-field"><label>DSP (Delivery Service Partner)</label><input type="text" id="add-dsp" placeholder=""></div>
                <div class="add-btns">
                    <button class="btn-add-save" onclick="saveNewVehicle()">üíæ Add Vehicle</button>
                    <button class="btn-add-cancel" onclick="cancelAddVehicle()">Cancel</button>
                </div>
            </div>
        </div>
    </div></div>

    <!-- QR OVERLAY -->
    <div class="qr-overlay" id="qr-overlay">
        <div class="qr-overlay-top">
            <button class="qr-back-btn" onclick="resetAudit()">‚Üê Back</button>
            <span class="qr-plate-title" id="qr-plate-title"></span>
            <span style="width:70px;"></span>
        </div>
        <div class="qr-overlay-body">
            <div class="qr-grounded-banner" id="qr-grounded-banner"><span>üö´ VEHICLE GROUNDED üö´<br>THIS VAN CANNOT GO OUT</span></div>
            <div class="qr-audit-status" id="qr-audit-status"></div>
            <div class="qr-code-wrap" id="qr-code-wrap"><div id="qr-code"></div></div>
            <div class="qr-vehicle-info" id="qr-vehicle-info"></div>
            <div class="qr-decision-area" id="qr-decision-area"><div class="qr-decision-row">
                <button onclick="vanOK()" class="btn-van-ok">‚úÖ VAN OK</button>
                <button onclick="vsaBlock()" class="btn-vsa-block">‚ùå VSA BLOCK</button>
            </div></div>
            <div class="qr-problem-area" id="qr-problem-area">
                <h3>‚ö†Ô∏è Describe the Problem</h3>
                <textarea id="problem-description" placeholder="Enter the problem details‚Ä¶"></textarea>
                <button onclick="submitBlock()" class="btn-submit-block">üíæ Save Block</button>
            </div>
            <div class="qr-saved-msg" id="qr-saved-msg"><span>‚úÖ Audit saved!</span></div>
        </div>
    </div>

    <!-- DOWNLOAD / REPORTS -->
    <div class="page" id="download-page"><div class="container">
        <div class="header"><h2>üìä Reports & Analytics</h2>
            <div class="header-actions">
                <button onclick="showPage('upload-page')" class="btn-secondary">Data Management</button>
                <button onclick="showPage('audit-page')" class="btn-primary">Go to Audit</button>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>
        </div>
        <div class="download-section">
            <h3>üìà Audit Statistics</h3>
            <p style="color:#aaa;margin-bottom:15px;font-size:13px;">Click any card to view details</p>
            <div class="stats-grid">
                <div class="stat-card" onclick="viewAuditData('all')"><div class="stat-value" id="report-total-audits">0</div><div class="stat-label">Total Audits</div></div>
                <div class="stat-card" onclick="viewAuditData('passed')"><div class="stat-value" id="report-passed">0</div><div class="stat-label">Passed (OK)</div></div>
                <div class="stat-card" onclick="viewAuditData('failed')"><div class="stat-value" id="report-failed">0</div><div class="stat-label">Failed (Blocked)</div></div>
                <div class="stat-card" onclick="viewAuditData('today')"><div class="stat-value" id="report-today">0</div><div class="stat-label">Today's Audits</div></div>
            </div>
            <h3 style="margin-top:30px;">üì• Download Reports</h3>
            <div class="download-buttons">
                <button onclick="downloadAllAudits()" class="btn btn-primary">Download All Audits</button>
                <button onclick="downloadPassedOnly()" class="btn btn-success">Download Passed Only</button>
                <button onclick="downloadFailedOnly()" class="btn btn-danger">Download Failed Only</button>
            </div>
            <div id="download-status"></div>
        </div>
    </div></div>

    <!-- DATA VIEW MODAL -->
    <div class="modal" id="data-modal"><div class="modal-content">
        <div class="modal-header"><h2 id="modal-title">Data View</h2><button class="modal-close" onclick="closeModal()">‚úï Close</button></div>
        <div id="modal-body"></div>
        <div class="modal-actions"><button onclick="exportModalData()" class="btn btn-success">üì• Export to CSV</button></div>
    </div></div>

<script>
// ================================================================
// FIREBASE
// ================================================================
const firebaseConfig={apiKey:"AIzaSyBpWSHW3fnPUvADjVxKNh5qpJ2lXkJNZRo",authDomain:"vsa-app-13a1f.firebaseapp.com",databaseURL:"https://vsa-app-13a1f-default-rtdb.europe-west1.firebasedatabase.app",projectId:"vsa-app-13a1f",storageBucket:"vsa-app-13a1f.firebasestorage.app",messagingSenderId:"1090077459793",appId:"1:1090077459793:web:5a3fcaca4923dce511bf70"};
let app,database,auth,firebaseInitialized=false;
try{app=firebase.initializeApp(firebaseConfig);database=firebase.database();auth=firebase.auth();firebaseInitialized=true;}catch(e){console.error(e);}

let vehicleDatabase=[],currentVehicle=null,auditResult=null,currentUser=null;

document.addEventListener('DOMContentLoaded',function(){
    setupEventListeners();checkLoginStatus();initializeCollapsibleSections();
});

function setupEventListeners(){
    document.getElementById('login-form').addEventListener('submit',handleLogin);
    const inp=document.getElementById('license-plate-input');
    inp.addEventListener('input',handleAutocomplete);
    inp.addEventListener('keyup',function(e){if(e.key==='Enter')searchVehicle();});
    document.addEventListener('click',function(e){if(!e.target.closest('.autocomplete-wrapper'))document.getElementById('autocomplete-list').style.display='none';});
}

// AUTH
async function handleLogin(e){
    e.preventDefault();
    const email=document.getElementById('username').value,pw=document.getElementById('password').value;
    if(!firebaseInitialized){document.getElementById('login-error').textContent='Firebase not configured.';document.getElementById('login-error').classList.remove('hidden');return;}
    try{
        showLoading('Authenticating...');
        const cred=await auth.signInWithEmailAndPassword(email,pw);
        currentUser={username:email,uid:cred.user.uid};
        document.getElementById('login-error').classList.add('hidden');
        await loadVehicleDataFromFirebase();hideLoading();
        showPage('upload-page');updateFirebaseStatus('connected','Logged in as: '+email);
    }catch(error){
        hideLoading();
        let msg='Login failed. ';
        switch(error.code){case'auth/invalid-email':msg+='Invalid email.';break;case'auth/user-not-found':msg+='No account.';break;case'auth/wrong-password':msg+='Wrong password.';break;case'auth/invalid-credential':msg+='Invalid credentials.';break;case'auth/too-many-requests':msg+='Too many attempts.';break;default:msg+=error.message;}
        document.getElementById('login-error').textContent=msg;document.getElementById('login-error').classList.remove('hidden');
    }
}
function checkLoginStatus(){
    if(firebaseInitialized&&auth.currentUser){currentUser={username:auth.currentUser.email,uid:auth.currentUser.uid};loadVehicleDataFromFirebase().then(()=>{showPage('upload-page');updateFirebaseStatus('connected','Logged in as: '+auth.currentUser.email);});}
    else showPage('login-page');
}
function logout(){if(auth)auth.signOut();currentUser=null;vehicleDatabase=[];showPage('login-page');}

// FIREBASE DATA
async function loadVehicleDataFromFirebase(){
    try{const s=await database.ref('vehicles').once('value');const d=s.val();vehicleDatabase=(d&&Array.isArray(d))?d:[];updateDatabaseStats();}
    catch(e){console.error(e);updateFirebaseStatus('error',e.message);}
}
async function saveVehicleDataToFirebase(){
    try{showLoading('Saving...');await database.ref('vehicles').set(vehicleDatabase);hideLoading();updateFirebaseStatus('connected',vehicleDatabase.length+' vehicles synced');return true;}
    catch(e){hideLoading();updateFirebaseStatus('error',e.message);return false;}
}
async function saveAuditToFirebase(audit){try{await database.ref('audits').push().set(audit);return true;}catch(e){console.error(e);return false;}}

function updateFirebaseStatus(status,detail=''){
    document.getElementById('firebase-status-section').style.display='block';
    document.getElementById('firebase-status').className='firebase-status '+status;
    const i=document.getElementById('firebase-icon'),t=document.getElementById('firebase-text'),d=document.getElementById('firebase-detail');
    if(status==='connected'){i.textContent='üü¢';t.textContent='Connected to Cloud Database';t.style.color='#28a745';d.textContent=detail||'All users share this database';}
    else if(status==='error'){i.textContent='üî¥';t.textContent='Cloud Connection Error';t.style.color='#dc3545';d.textContent=detail;}
    else{i.textContent='üü°';t.textContent='Syncing...';t.style.color='#ffc107';d.textContent=detail;}
}

// NAV
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');clearAllStatusMessages();if(id==='upload-page')updateDatabaseStats();else if(id==='download-page')updateReportStats();}
function toggleSection(id){const c=document.getElementById(id+'-content'),i=document.getElementById(id+'-icon');if(c.classList.contains('hidden')){c.classList.remove('hidden');i.classList.remove('collapsed');localStorage.setItem('section-'+id,'expanded');}else{c.classList.add('hidden');i.classList.add('collapsed');localStorage.setItem('section-'+id,'collapsed');}}
function initializeCollapsibleSections(){['firebase-status','upload-files'].forEach(id=>{const s=localStorage.getItem('section-'+id),c=document.getElementById(id+'-content'),i=document.getElementById(id+'-icon');if(!c||!i)return;if(s==='collapsed'||(id==='upload-files'&&!s)){c.classList.add('hidden');i.classList.add('collapsed');}else if(s==='expanded'){c.classList.remove('hidden');i.classList.remove('collapsed');}});}
function clearAllStatusMessages(){['upload-status','clear-status','download-status'].forEach(id=>{const el=document.getElementById(id);if(el){el.style.display='none';el.textContent='';el.className='status-message';}});}

// FILE UPLOAD
let uploadedFiles={'dive-deep':null,'vin-audit':null,'grounded':null};
function handleFileSelect(input,type){
    const file=input.files[0];if(!file)return;const fn=file.name.toLowerCase();let ok=false,err='';
    switch(type){
        case'dive-deep':if(!fn.endsWith('.csv'))err='‚ùå Must be CSV';else if(!(fn.includes('dive')||fn.includes('deep')||fn.includes('expected')||fn.includes('vehicle')))err='‚ùå Wrong file';else ok=true;break;
        case'vin-audit':if(!fn.endsWith('.xlsx')&&!fn.endsWith('.xls'))err='‚ùå Must be Excel';else if(!(fn.includes('vin')&&(fn.includes('audit')||fn.includes('detail'))))err='‚ùå Wrong file';else ok=true;break;
        case'grounded':if(!fn.endsWith('.xlsx')&&!fn.endsWith('.xls'))err='‚ùå Must be Excel';else if(!(fn.includes('ground')||(fn.includes('current')&&fn.includes('veh'))))err='‚ùå Wrong file';else ok=true;break;
    }
    const n=document.getElementById(type+'-name');
    if(ok){uploadedFiles[type]=file;n.innerHTML='‚úÖ '+file.name;n.style.color='#28a745';}
    else{uploadedFiles[type]=null;input.value='';n.innerHTML=err;n.style.color='#dc3545';alert(err+'\n\nFile: '+file.name);}
}
async function processFiles(){
    if(!uploadedFiles['dive-deep']||!uploadedFiles['vin-audit']||!uploadedFiles['grounded']){showStatus('upload-status','‚ö†Ô∏è Upload all three files.','error');return;}
    if(!confirm('‚ö†Ô∏è NEW CYCLE\n\nClears ALL data. Affects ALL USERS.\n\nContinue?')){showStatus('upload-status','Cancelled','info');return;}
    showLoading('Clearing...');
    try{
        await database.ref('vehicles').remove();await database.ref('audits').remove();
        showLoading('Processing...');
        const dd=await readCSV(uploadedFiles['dive-deep']),va=await readExcel(uploadedFiles['vin-audit'],5),gr=await readExcel(uploadedFiles['grounded'],2);
        buildVehicleDatabase(dd,va,gr);
        const saved=await saveVehicleDataToFirebase();hideLoading();
        if(saved){showStatus('upload-status','‚úÖ '+vehicleDatabase.length+' vehicles uploaded.','success');updateDatabaseStats();uploadedFiles={'dive-deep':null,'vin-audit':null,'grounded':null};['dive-deep-file','vin-audit-file','grounded-file'].forEach(id=>document.getElementById(id).value='');['dive-deep-name','vin-audit-name','grounded-name'].forEach(id=>document.getElementById(id).innerHTML='');}
        else showStatus('upload-status','‚ö†Ô∏è Cloud save failed.','error');
    }catch(e){hideLoading();showStatus('upload-status','Error: '+e.message,'error');}
}
function readCSV(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>{const lines=e.target.result.split('\n'),data=[];for(let i=1;i<lines.length;i++){const l=lines[i].trim();if(l){const v=l.split(',');data.push({dsp:v[2],vin:v[4],licensePlate:v[5],status:v[6]});}}res(data);};r.onerror=rej;r.readAsText(file);});}
function readExcel(file,skip){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:null}).slice(skip));}catch(err){rej(err);}};r.onerror=rej;r.readAsArrayBuffer(file);});}
function buildVehicleDatabase(dd,va,gr){
    vehicleDatabase=[];const vm=new Map();va.forEach(r=>{if(r[6])vm.set(r[6],r[10]);});const gs=new Set();gr.forEach(r=>{if(r[6])gs.add(r[6]);});
    dd.forEach(v=>{if(v.vin&&v.licensePlate)vehicleDatabase.push({vin:v.vin,licensePlate:v.licensePlate.toUpperCase(),dsp:v.dsp,status:v.status,isGrounded:gs.has(v.vin),lastAudit:vm.get(v.vin)||null});});
}
function updateDatabaseStats(){
    document.getElementById('total-vehicles').textContent=vehicleDatabase.length;
    document.getElementById('grounded-count').textContent=vehicleDatabase.filter(v=>v.isGrounded).length;
    document.getElementById('audited-count').textContent=vehicleDatabase.filter(v=>v.lastAudit).length;
    document.getElementById('to-audit-count').textContent=vehicleDatabase.filter(v=>!v.lastAudit&&!v.isGrounded).length;
    updateAuditProgress();
}

// AUDIT PROGRESS ‚Äî fixed 70% target
function getISOWeek(d){d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));var ys=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-ys)/86400000)+1)/7);}
function updateAuditProgress(){
    const week=getISOWeek(new Date()),target=70;
    const total=vehicleDatabase.filter(v=>!v.isGrounded).length;
    const audited=vehicleDatabase.filter(v=>v.lastAudit&&!v.isGrounded).length;
    const pct=total>0?Math.round((audited/total)*100):0;
    const needed=Math.max(0,Math.ceil(target*total/100)-audited);
    const met=pct>=target;
    document.getElementById('progress-week-badge').textContent='Week '+week;
    document.getElementById('progress-target-badge').innerHTML='Target: <strong>'+target+'%</strong>';
    const fill=document.getElementById('progress-fill');fill.style.width=Math.min(pct,100)+'%';fill.textContent=pct+'%';fill.className='progress-bar-fill '+(met?'met':'not-met');
    const mk=document.getElementById('progress-target-marker');mk.style.left=target+'%';mk.setAttribute('data-label','Target '+target+'%');
    document.getElementById('prog-current-pct').textContent=pct+'%';document.getElementById('prog-target-pct').textContent=target+'%';
    document.getElementById('prog-audited').textContent=audited;document.getElementById('prog-total').textContent=total;document.getElementById('prog-needed').textContent=needed;
    document.getElementById('prog-needed-card').className='progress-num-card highlight-needed'+(needed===0?' zero':'');
}

// DB CLEARING
async function clearVehicleDatabase(){if(!window.confirm('Clear ALL vehicle data? Affects all users.'))return;try{showLoading('Clearing...');await database.ref('vehicles').remove();vehicleDatabase=[];hideLoading();updateDatabaseStats();showStatus('clear-status','‚úÖ Vehicle database cleared.','success');}catch(e){hideLoading();showStatus('clear-status','‚ùå '+e.message,'error');}}
async function clearAuditDatabase(){if(!window.confirm('Clear ALL audit records? Affects all users.'))return;try{showLoading('Clearing...');await database.ref('audits').remove();hideLoading();showStatus('clear-status','‚úÖ Audit database cleared.','success');if(document.getElementById('download-page').classList.contains('active'))updateReportStats();}catch(e){hideLoading();showStatus('clear-status','‚ùå '+e.message,'error');}}
async function clearAllDatabases(){if(!window.confirm('‚ö†Ô∏è CLEAR EVERYTHING? Affects all users!'))return;if(!window.confirm('FINAL CONFIRMATION?'))return;const t=prompt('Type "DELETE ALL":');if(t!=='DELETE ALL'){alert('Cancelled.');return;}try{showLoading('Clearing...');await database.ref('vehicles').remove();await database.ref('audits').remove();vehicleDatabase=[];hideLoading();updateDatabaseStats();showStatus('clear-status','‚úÖ Everything cleared.','success');}catch(e){hideLoading();showStatus('clear-status','‚ùå '+e.message,'error');}}

// AUTOCOMPLETE
function handleAutocomplete(){
    const inp=document.getElementById('license-plate-input'),val=inp.value.toUpperCase(),list=document.getElementById('autocomplete-list');
    document.getElementById('add-vehicle-card').classList.remove('show');
    if(val.length<2){list.style.display='none';return;}
    const m=vehicleDatabase.filter(v=>v.licensePlate.includes(val)).slice(0,10);
    if(!m.length){list.style.display='none';return;}
    list.innerHTML=m.map(v=>`<div class="autocomplete-item" onclick="selectVehicle('${v.licensePlate}')"><strong>${v.licensePlate}</strong> ‚Äî ${v.dsp} ‚Äî ‚Ä¶${v.vin.substr(-6)}</div>`).join('');
    list.style.display='block';
}
function selectVehicle(plate){document.getElementById('license-plate-input').value=plate;document.getElementById('autocomplete-list').style.display='none';searchVehicle();}

// SEARCH ‚Üí immediate QR
function searchVehicle(){
    const plate=document.getElementById('license-plate-input').value.toUpperCase().trim();if(!plate)return;
    document.getElementById('autocomplete-list').style.display='none';
    const v=vehicleDatabase.find(x=>x.licensePlate===plate);
    if(!v){document.getElementById('add-plate').value=plate;document.getElementById('add-dsp').value='';document.getElementById('add-vehicle-card').classList.add('show');return;}
    document.getElementById('add-vehicle-card').classList.remove('show');
    currentVehicle=v;auditResult=null;showQROverlay();
}

// ADD NEW VEHICLE
async function saveNewVehicle(){
    const plate=document.getElementById('add-plate').value.toUpperCase().trim(),dsp=document.getElementById('add-dsp').value.trim();
    if(!plate){alert('No plate');return;}
    const nv={vin:'MANUAL-'+plate+'-'+Date.now(),licensePlate:plate,dsp:dsp||'N/A',status:'Active',isGrounded:false,lastAudit:null};
    vehicleDatabase.push(nv);showLoading('Adding...');const saved=await saveVehicleDataToFirebase();hideLoading();
    if(saved){document.getElementById('add-vehicle-card').classList.remove('show');updateDatabaseStats();document.getElementById('license-plate-input').value='';alert('‚úÖ Vehicle '+plate+' added to database');}
    else{vehicleDatabase.pop();alert('‚ö†Ô∏è Cloud save failed');}
}
function cancelAddVehicle(){document.getElementById('add-vehicle-card').classList.remove('show');document.getElementById('license-plate-input').value='';document.getElementById('license-plate-input').focus();}

// QR OVERLAY
function showQROverlay(){
    const qr=document.getElementById('qr-code');qr.innerHTML='';
    new QRCode(qr,{text:currentVehicle.vin,width:220,height:220,colorDark:'#000000',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});
    document.getElementById('qr-plate-title').textContent=currentVehicle.licensePlate;
    document.getElementById('qr-grounded-banner').classList.toggle('show',currentVehicle.isGrounded);
    // Audit status badge
    const statusEl=document.getElementById('qr-audit-status');
    if(currentVehicle.lastAudit){statusEl.className='qr-audit-status done';statusEl.textContent='‚úÖ ALREADY AUDITED ‚Äî '+currentVehicle.lastAudit;}
    else{statusEl.className='qr-audit-status todo';statusEl.textContent='üîç TO BE AUDITED';}
    // Vehicle info
    document.getElementById('qr-vehicle-info').innerHTML=
        '<strong>DSP:</strong> '+currentVehicle.dsp+' ¬∑ <strong>Status:</strong> '+(currentVehicle.isGrounded?'üö´ GROUNDED':'‚úÖ ACTIVE')+'<br>'+
        '<strong>VIN:</strong> <span class="qr-vin">'+currentVehicle.vin+'</span>';
    // Reset UI state
    document.getElementById('qr-code-wrap').classList.remove('shrunk');
    document.getElementById('qr-decision-area').style.display='';
    document.getElementById('qr-problem-area').classList.remove('show');
    document.getElementById('qr-saved-msg').classList.remove('show');
    document.getElementById('problem-description').value='';
    document.getElementById('qr-overlay').classList.add('show');
}
function resetAudit(){
    document.getElementById('qr-overlay').classList.remove('show');currentVehicle=null;auditResult=null;
    document.getElementById('license-plate-input').value='';document.getElementById('problem-description').value='';
    document.getElementById('add-vehicle-card').classList.remove('show');document.getElementById('license-plate-input').focus();
}

// AUDIT DECISIONS
async function vanOK(){
    if(!currentVehicle)return;auditResult={result:'PASSED',problem:null};
    document.getElementById('qr-decision-area').style.display='none';
    const saved=await doSaveAudit();
    if(saved){document.getElementById('qr-saved-msg').classList.add('show');setTimeout(()=>resetAudit(),800);}
    else document.getElementById('qr-decision-area').style.display='';
}
function vsaBlock(){
    if(!currentVehicle)return;
    document.getElementById('qr-decision-area').style.display='none';
    document.getElementById('qr-code-wrap').classList.add('shrunk');
    document.getElementById('qr-problem-area').classList.add('show');
    setTimeout(()=>document.getElementById('problem-description').focus(),100);
}
async function submitBlock(){
    const p=document.getElementById('problem-description').value.trim();
    if(!p){alert('Please describe the problem');return;}
    auditResult={result:'FAILED',problem:p};
    document.getElementById('qr-problem-area').classList.remove('show');
    const saved=await doSaveAudit();
    if(saved){document.getElementById('qr-saved-msg').classList.add('show');setTimeout(()=>resetAudit(),800);}
}
async function doSaveAudit(){
    if(!currentVehicle||!auditResult)return false;
    const audit={id:Date.now(),vin:currentVehicle.vin,licensePlate:currentVehicle.licensePlate,dsp:currentVehicle.dsp,result:auditResult.result,problem:auditResult.problem,timestamp:new Date().toISOString(),date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),user:currentUser?currentUser.username:'unknown'};
    const saved=await saveAuditToFirebase(audit);if(!saved){alert('‚ö†Ô∏è Cloud save failed');return false;}
    const v=vehicleDatabase.find(x=>x.licensePlate===currentVehicle.licensePlate);if(v)v.lastAudit=audit.date;
    updateDatabaseStats();return true;
}

// REPORTS
async function updateReportStats(){try{const s=await database.ref('audits').once('value');const a=[];s.forEach(c=>a.push(c.val()));const t=new Date().toLocaleDateString();document.getElementById('report-total-audits').textContent=a.length;document.getElementById('report-passed').textContent=a.filter(x=>x.result==='PASSED').length;document.getElementById('report-failed').textContent=a.filter(x=>x.result==='FAILED').length;document.getElementById('report-today').textContent=a.filter(x=>x.date===t).length;}catch(e){console.error(e);}}
async function downloadAllAudits(){await downloadAudits('all');}
async function downloadPassedOnly(){await downloadAudits('passed');}
async function downloadFailedOnly(){await downloadAudits('failed');}
async function downloadAudits(type){
    try{showLoading('Loading...');const s=await database.ref('audits').once('value');let a=[];s.forEach(c=>a.push(c.val()));
    if(type==='passed')a=a.filter(x=>x.result==='PASSED');else if(type==='failed')a=a.filter(x=>x.result==='FAILED');
    hideLoading();if(!a.length){alert('No audits');return;}
    const h=['ID','Date','Time','Plate','VIN','DSP','Result','Problem','User'];
    const csv=[h,...a.map(x=>[x.id,x.date,x.time,x.licensePlate,x.vin,x.dsp,x.result,x.problem||'',x.user||''])].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const el=document.createElement('a');el.href=url;el.download='vsa_audits_'+type+'_'+new Date().toISOString().split('T')[0]+'.csv';el.click();
    showStatus('download-status','Downloaded '+a.length+' records','success');}catch(e){hideLoading();alert('Error: '+e.message);}
}

// UTILITY
let statusTimers={};
function showStatus(id,msg,type){const el=document.getElementById(id);el.className='status-message status-'+type;el.innerHTML=msg.replace(/\n/g,'<br>');el.style.display='block';if(statusTimers[id])clearTimeout(statusTimers[id]);if(type==='success'||type==='info'){statusTimers[id]=setTimeout(()=>{el.style.transition='opacity 0.5s';el.style.opacity='0';setTimeout(()=>{el.style.display='none';el.style.opacity='1';el.style.transition='';},500);},5000);}}
function showLoading(t){document.getElementById('loading-text').textContent=t;document.getElementById('loading-overlay').classList.add('show');}
function hideLoading(){document.getElementById('loading-overlay').classList.remove('show');}

// MODAL
let currentModalData=[],currentModalType='',modalSortCol=null,modalSortDir='asc';
function closeModal(){document.getElementById('data-modal').classList.remove('show');}

function viewVehicleData(type){
    let data=[],title='';
    switch(type){case'active':data=vehicleDatabase.slice();title='All Active Vehicles';break;case'grounded':data=vehicleDatabase.filter(v=>v.isGrounded);title='Grounded Vehicles';break;case'audited':data=vehicleDatabase.filter(v=>v.lastAudit);title='Already Audited';break;case'to-audit':data=vehicleDatabase.filter(v=>!v.lastAudit&&!v.isGrounded);title='üöê To Be Audited';break;}
    if(!data.length){showModalEmpty(title,'No vehicles found.');return;}
    currentModalData=data;currentModalType='vehicle';modalSortCol=null;modalSortDir='asc';
    document.getElementById('modal-title').textContent=title;
    const dspSet=[...new Set(data.map(v=>v.dsp))].sort();
    document.getElementById('modal-body').innerHTML='<div class="modal-toolbar"><input class="search-input" type="text" id="v-search" placeholder="üîç Search‚Ä¶" oninput="renderVehicleTable()"><div class="toolbar-group"><span class="toolbar-label">DSP</span><div class="ms-wrap" id="v-dsp">'+dspSet.map(d=>'<button class="ms-pill" data-val="'+d+'" onclick="togglePill(this,\'renderVehicleTable\')">'+d+'</button>').join('')+'</div></div><div class="toolbar-group"><span class="toolbar-label">Status</span><div class="ms-wrap" id="v-status"><button class="ms-pill" data-val="active" onclick="togglePill(this,\'renderVehicleTable\')">Active</button><button class="ms-pill" data-val="grounded" onclick="togglePill(this,\'renderVehicleTable\')">Grounded</button><button class="ms-pill" data-val="audited" onclick="togglePill(this,\'renderVehicleTable\')">Audited</button><button class="ms-pill" data-val="not-audited" onclick="togglePill(this,\'renderVehicleTable\')">Not Audited</button></div></div><span class="modal-count" id="v-count">'+data.length+' vehicles</span></div><div id="v-table"></div>';
    renderVehicleTable();document.getElementById('data-modal').classList.add('show');
}
function renderVehicleTable(){
    const search=document.getElementById('v-search').value.toLowerCase(),dsps=getSelectedPills('v-dsp'),statuses=getSelectedPills('v-status');
    let f=currentModalData.filter(v=>{if(search&&!v.licensePlate.toLowerCase().includes(search)&&!v.vin.toLowerCase().includes(search))return false;if(dsps.length&&!dsps.includes(v.dsp))return false;if(statuses.length&&!statuses.some(s=>s==='active'?!v.isGrounded:s==='grounded'?v.isGrounded:s==='audited'?!!v.lastAudit:!v.lastAudit))return false;return true;});
    if(modalSortCol)f.sort((a,b)=>{let va=getVSV(a,modalSortCol),vb=getVSV(b,modalSortCol);return va<vb?(modalSortDir==='asc'?-1:1):va>vb?(modalSortDir==='asc'?1:-1):0;});
    document.getElementById('v-count').textContent=f.length+' vehicles';
    const cols=[{k:'licensePlate',l:'Plate'},{k:'vin',l:'VIN'},{k:'dsp',l:'DSP'},{k:'status',l:'Status'},{k:'lastAudit',l:'Last Audit'}];
    const th=cols.map(c=>{let a='',cl='';if(modalSortCol===c.k){a=modalSortDir==='asc'?'‚ñ≤':'‚ñº';cl=' class="active-sort"';}return'<th'+cl+' onclick="sortV(\''+c.k+'\')">'+c.l+'<span class="sort-arrow">'+(a||'‚áÖ')+'</span></th>';}).join('');
    const tb=f.map(v=>'<tr><td><strong>'+v.licensePlate+'</strong></td><td>'+v.vin+'</td><td>'+v.dsp+'</td><td>'+(v.isGrounded?'<span class="status-badge-table badge-grounded-table">GROUNDED</span>':'<span class="status-badge-table badge-active-table">ACTIVE</span>')+'</td><td>'+(v.lastAudit||'‚Äî')+'</td></tr>').join('');
    document.getElementById('v-table').innerHTML='<table class="data-table"><thead><tr>'+th+'</tr></thead><tbody>'+(tb||'<tr><td colspan="5" style="text-align:center;color:#aaa;padding:30px;">No matches</td></tr>')+'</tbody></table>';
}
function getVSV(v,c){switch(c){case'licensePlate':return v.licensePlate.toLowerCase();case'vin':return v.vin.toLowerCase();case'dsp':return v.dsp.toLowerCase();case'status':return v.isGrounded?'z':'a';case'lastAudit':return v.lastAudit||'';default:return'';}}
function sortV(c){if(modalSortCol===c)modalSortDir=modalSortDir==='asc'?'desc':'asc';else{modalSortCol=c;modalSortDir='asc';}renderVehicleTable();}

async function viewAuditData(type){
    try{showLoading('Loading‚Ä¶');const s=await database.ref('audits').once('value');let a=[];s.forEach(c=>a.push(c.val()));let data=[],title='';const today=new Date().toLocaleDateString();
    switch(type){case'all':data=a;title='All Audits';break;case'passed':data=a.filter(x=>x.result==='PASSED');title='Passed';break;case'failed':data=a.filter(x=>x.result==='FAILED');title='Failed';break;case'today':data=a.filter(x=>x.date===today);title="Today's Audits";break;}
    hideLoading();if(!data.length){showModalEmpty(title,'No audits found.');return;}
    currentModalData=data;currentModalType='audit';modalSortCol=null;modalSortDir='asc';
    document.getElementById('modal-title').textContent=title;
    const dspSet=[...new Set(data.map(x=>x.dsp))].sort(),userSet=[...new Set(data.map(x=>x.user||'Unknown'))].sort();
    document.getElementById('modal-body').innerHTML='<div class="modal-toolbar"><input class="search-input" type="text" id="a-search" placeholder="üîç Search‚Ä¶" oninput="renderAuditTable()"><div class="toolbar-group"><span class="toolbar-label">Result</span><div class="ms-wrap" id="a-result"><button class="ms-pill" data-val="PASSED" onclick="togglePill(this,\'renderAuditTable\')">Passed</button><button class="ms-pill" data-val="FAILED" onclick="togglePill(this,\'renderAuditTable\')">Failed</button></div></div><div class="toolbar-group"><span class="toolbar-label">DSP</span><div class="ms-wrap" id="a-dsp">'+dspSet.map(d=>'<button class="ms-pill" data-val="'+d+'" onclick="togglePill(this,\'renderAuditTable\')">'+d+'</button>').join('')+'</div></div><div class="toolbar-group"><span class="toolbar-label">User</span><div class="ms-wrap" id="a-user">'+userSet.map(u=>'<button class="ms-pill" data-val="'+u+'" onclick="togglePill(this,\'renderAuditTable\')">'+u+'</button>').join('')+'</div></div><span class="modal-count" id="a-count">'+data.length+' audits</span></div><div id="a-table"></div>';
    renderAuditTable();document.getElementById('data-modal').classList.add('show');
    }catch(e){hideLoading();alert('Error: '+e.message);}
}
function renderAuditTable(){
    const search=document.getElementById('a-search').value.toLowerCase(),results=getSelectedPills('a-result'),dsps=getSelectedPills('a-dsp'),users=getSelectedPills('a-user');
    let f=currentModalData.filter(a=>{if(search&&!a.licensePlate.toLowerCase().includes(search)&&!a.vin.toLowerCase().includes(search))return false;if(results.length&&!results.includes(a.result))return false;if(dsps.length&&!dsps.includes(a.dsp))return false;if(users.length&&!users.includes(a.user||'Unknown'))return false;return true;});
    if(modalSortCol)f.sort((a,b)=>{let va=getASV(a,modalSortCol),vb=getASV(b,modalSortCol);return va<vb?(modalSortDir==='asc'?-1:1):va>vb?(modalSortDir==='asc'?1:-1):0;});
    document.getElementById('a-count').textContent=f.length+' audits';
    const cols=[{k:'date',l:'Date'},{k:'time',l:'Time'},{k:'licensePlate',l:'Plate'},{k:'vin',l:'VIN'},{k:'dsp',l:'DSP'},{k:'result',l:'Result'},{k:'problem',l:'Problem'},{k:'user',l:'User'}];
    const th=cols.map(c=>{let a='',cl='';if(modalSortCol===c.k){a=modalSortDir==='asc'?'‚ñ≤':'‚ñº';cl=' class="active-sort"';}return'<th'+cl+' onclick="sortA(\''+c.k+'\')">'+c.l+'<span class="sort-arrow">'+(a||'‚áÖ')+'</span></th>';}).join('');
    const tb=f.map(a=>'<tr><td>'+a.date+'</td><td>'+a.time+'</td><td><strong>'+a.licensePlate+'</strong></td><td>'+a.vin+'</td><td>'+a.dsp+'</td><td>'+(a.result==='PASSED'?'<span class="status-badge-table badge-passed-table">PASSED</span>':'<span class="status-badge-table badge-failed-table">FAILED</span>')+'</td><td>'+(a.problem||'‚Äî')+'</td><td>'+(a.user||'?')+'</td></tr>').join('');
    document.getElementById('a-table').innerHTML='<table class="data-table"><thead><tr>'+th+'</tr></thead><tbody>'+(tb||'<tr><td colspan="8" style="text-align:center;color:#aaa;padding:30px;">No matches</td></tr>')+'</tbody></table>';
}
function getASV(a,c){switch(c){case'date':return a.date||'';case'time':return a.time||'';case'licensePlate':return a.licensePlate.toLowerCase();case'vin':return a.vin.toLowerCase();case'dsp':return a.dsp.toLowerCase();case'result':return a.result||'';case'problem':return(a.problem||'').toLowerCase();case'user':return(a.user||'').toLowerCase();default:return'';}}
function sortA(c){if(modalSortCol===c)modalSortDir=modalSortDir==='asc'?'desc':'asc';else{modalSortCol=c;modalSortDir='asc';}renderAuditTable();}
function showModalEmpty(title,msg){document.getElementById('modal-title').textContent=title;document.getElementById('modal-body').innerHTML='<div class="empty-data"><p>'+msg+'</p></div>';document.getElementById('data-modal').classList.add('show');}

function exportModalData(){
    const rows=document.querySelectorAll('.data-table tbody tr');if(!rows.length){alert('No data.');return;}
    const mTitle=document.getElementById('modal-title').textContent,date=new Date().toISOString().split('T')[0];let csv='',fn='';
    if(currentModalType==='vehicle'){fn='vehicles_'+mTitle.toLowerCase().replace(/[^a-z0-9]/g,'_')+'_'+date+'.csv';const h=['Plate','VIN','DSP','Status','Last Audit'],search=document.getElementById('v-search').value.toLowerCase(),dsps=getSelectedPills('v-dsp'),statuses=getSelectedPills('v-status');let f=currentModalData.filter(v=>{if(search&&!v.licensePlate.toLowerCase().includes(search)&&!v.vin.toLowerCase().includes(search))return false;if(dsps.length&&!dsps.includes(v.dsp))return false;if(statuses.length&&!statuses.some(s=>s==='active'?!v.isGrounded:s==='grounded'?v.isGrounded:s==='audited'?!!v.lastAudit:!v.lastAudit))return false;return true;});csv=[h,...f.map(v=>[v.licensePlate,v.vin,v.dsp,v.isGrounded?'GROUNDED':'ACTIVE',v.lastAudit||''])].map(r=>r.map(c=>'"'+c+'"').join(',')).join('\n');}
    else{fn='audits_'+mTitle.toLowerCase().replace(/[^a-z0-9]/g,'_')+'_'+date+'.csv';const h=['Date','Time','Plate','VIN','DSP','Result','Problem','User'],search=document.getElementById('a-search').value.toLowerCase(),results=getSelectedPills('a-result'),dsps=getSelectedPills('a-dsp'),users=getSelectedPills('a-user');let f=currentModalData.filter(a=>{if(search&&!a.licensePlate.toLowerCase().includes(search)&&!a.vin.toLowerCase().includes(search))return false;if(results.length&&!results.includes(a.result))return false;if(dsps.length&&!dsps.includes(a.dsp))return false;if(users.length&&!users.includes(a.user||'Unknown'))return false;return true;});csv=[h,...f.map(a=>[a.date,a.time,a.licensePlate,a.vin,a.dsp,a.result,a.problem||'',a.user||''])].map(r=>r.map(c=>'"'+c+'"').join(',')).join('\n');}
    const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob),el=document.createElement('a');el.href=url;el.download=fn;el.click();
}

function togglePill(btn,fn){btn.classList.toggle('on');if(typeof window[fn]==='function')window[fn]();}
function getSelectedPills(id){const c=document.getElementById(id);if(!c)return[];return[...c.querySelectorAll('.ms-pill.on')].map(b=>b.dataset.val);}
document.addEventListener('click',function(e){if(e.target===document.getElementById('data-modal'))closeModal();});
</script>
</body>
</html>
