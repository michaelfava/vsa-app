<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon VSA Audit System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Amazon Ember', Arial, sans-serif;
            background: linear-gradient(135deg, #232F3E 0%, #131A22 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #FF9900;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #ccc;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FF9900;
            background: rgba(255, 255, 255, 0.15);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: #FF9900;
            color: #131A22;
        }

        .btn-primary:hover {
            background: #FFB84D;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h2 {
            color: #FF9900;
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        /* Upload Page */
        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .upload-section h3 {
            color: #FF9900;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            border-color: #FF9900;
            background: rgba(255, 255, 255, 0.1);
        }

        .file-name {
            color: #28a745;
            margin-top: 5px;
            font-size: 14px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }

        .status-info {
            background: rgba(255, 153, 0, 0.2);
            border: 1px solid #FF9900;
            color: #FF9900;
        }

        /* Audit Page */
        .search-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .autocomplete-wrapper {
            position: relative;
            z-index: 10000;
        }

        #license-plate-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            text-transform: uppercase;
        }

        #license-plate-input:focus {
            outline: none;
            border-color: #FF9900;
            background: rgba(255, 255, 255, 0.15);
        }

        #autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #232F3E;
            border: 2px solid #FF9900;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: rgba(255, 153, 0, 0.2);
        }

        .autocomplete-item strong {
            color: #FF9900;
        }

        /* Vehicle Info */
        .vehicle-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            transition: all 0.3s ease-in-out;
        }

        .vehicle-info.show {
            display: block;
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row.last-audit-row {
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        /* Yellow warning for NOT AUDITED vehicles */
        .info-row.last-audit-row.needs-vsa {
            background: rgba(255, 193, 7, 0.15);
            border: 3px solid #ffc107;
            border-bottom: 3px solid #ffc107;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        /* Normal display for already audited vehicles */
        .info-row.last-audit-row.already-audited {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            border-bottom: 2px solid #28a745;
        }

        /* RED WARNING for GROUNDED vehicles */
        .grounded-warning {
            background: rgba(220, 53, 69, 0.2);
            border: 3px solid #dc3545;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            animation: pulseGroundedWarning 1.5s ease-in-out infinite;
        }

        .grounded-warning-text {
            font-size: 22px;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
            }
        }

        @keyframes pulseGroundedWarning {
            0%, 100% {
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
            }
            50% {
                box-shadow: 0 0 30px rgba(220, 53, 69, 1);
            }
        }

        .info-label {
            color: #aaa;
            font-weight: bold;
        }

        .info-label.last-audit-label {
            font-size: 20px;
            font-weight: bold;
        }

        .info-label.last-audit-label.needs-vsa {
            color: #ffc107;
        }

        .info-label.last-audit-label.already-audited {
            color: #28a745;
        }

        .info-value {
            color: #fff;
            text-align: right;
        }

        .info-value.last-audit-value {
            font-size: 24px;
            font-weight: bold;
        }

        .info-value.last-audit-value.needs-vsa {
            color: #ffc107;
        }

        .info-value.last-audit-value.already-audited {
            color: #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-active {
            background: #28a745;
        }

        .badge-grounded {
            background: #dc3545;
        }

        .badge-checked {
            background: #17a2b8;
        }

        .badge-pending {
            background: #ffc107;
            color: #000;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-van-ok {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-van-ok:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .btn-vsa-block {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-vsa-block:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        /* Problem Input */
        .problem-section {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .problem-section.show {
            display: block;
        }

        #problem-description {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            resize: vertical;
        }

        /* QR Code Section */
        .qr-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .qr-section.show {
            display: block;
        }

        .qr-section h3 {
            color: #131A22;
            margin-bottom: 20px;
        }

        #qr-code {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 20px 0;
        }

        .qr-info {
            color: #131A22;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Download Page */
        .download-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #FF9900;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #aaa;
            font-size: 14px;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .download-buttons button {
            flex: 1;
            min-width: 200px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #FF9900;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            position: absolute;
            margin-top: 100px;
            color: #FF9900;
            font-size: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                flex-direction: column;
            }

            .header-actions button {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .download-buttons {
                flex-direction: column;
            }

            .download-buttons button {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div>
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Processing...</div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="page active" id="login-page">
        <div class="login-container">
            <div class="login-box">
                <div class="logo">
                    <h1>üöê VSA Audit</h1>
                    <p>Vehicle Safety Audit System</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <div id="login-error" class="status-message status-error hidden" style="margin-top: 15px;">
                    Invalid credentials
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Page -->
    <div class="page" id="upload-page">
        <div class="container">
            <div class="header">
                <h2>üìÅ Data Management</h2>
                <div class="header-actions">
                    <button onclick="showPage('audit-page')" class="btn-primary">Go to Audit</button>
                    <button onclick="showPage('download-page')" class="btn-secondary">View Reports</button>
                    <button onclick="logout()" class="btn-danger">Logout</button>
                </div>
            </div>

            <div class="upload-section">
                <h3>üìä Upload Data Files</h3>
                <p style="color: #aaa; margin-bottom: 20px;">Upload all three files to update the vehicle database</p>

                <div class="file-input-wrapper">
                    <input type="file" id="dive-deep-file" accept=".csv" onchange="handleFileSelect(this, 'dive-deep')">
                    <label for="dive-deep-file" class="file-input-label">
                        üìÑ Click to select Dive Deep CSV
                        <div class="file-name" id="dive-deep-name"></div>
                    </label>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="vin-audit-file" accept=".xlsx" onchange="handleFileSelect(this, 'vin-audit')">
                    <label for="vin-audit-file" class="file-input-label">
                        üìã Click to select VIN Audit Detail XLSX
                        <div class="file-name" id="vin-audit-name"></div>
                    </label>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="grounded-file" accept=".xlsx" onchange="handleFileSelect(this, 'grounded')">
                    <label for="grounded-file" class="file-input-label">
                        üö´ Click to select Current Grounded XLSX
                        <div class="file-name" id="grounded-name"></div>
                    </label>
                </div>

                <button onclick="processFiles()" class="btn btn-primary" style="margin-top: 20px;">
                    Process Files
                </button>

                <div id="upload-status"></div>
            </div>

            <div class="upload-section">
                <h3>‚òÅÔ∏è Google Drive Auto-Sync</h3>
                <p style="color: #aaa; margin-bottom: 20px;">Automatic cloud sync - works once app is hosted online (GitHub Pages)</p>
                
                <div id="google-drive-status" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="gdrive-status-icon" style="font-size: 24px;">üî¥</span>
                        <div>
                            <div id="gdrive-status-text" style="font-weight: bold;"></div>
                            <div id="gdrive-user-email" style="font-size: 12px; color: #aaa;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button id="google-signin-btn" onclick="signInToGoogle()" class="btn btn-success" style="flex: 1; min-width: 200px;">
                        üîê Connect Google Drive
                    </button>
                    <button id="google-signout-btn" onclick="signOutFromGoogle()" class="btn btn-secondary" style="flex: 1; min-width: 200px; display: none;">
                        üö™ Disconnect
                    </button>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                    <button onclick="manualSyncToGoogleDrive()" class="btn btn-info" style="flex: 1; min-width: 200px;">
                        ‚òÅÔ∏è Save to Drive
                    </button>
                    <button onclick="manualLoadFromGoogleDrive()" class="btn btn-info" style="flex: 1; min-width: 200px;">
                        üì• Load from Drive
                    </button>
                </div>
                
                <div id="sync-status"></div>
                
                <div style="background: rgba(66, 133, 244, 0.1); border: 1px solid #4285f4; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <strong style="color: #4285f4;">üí° Setup Instructions:</strong>
                    <ol style="color: #ccc; margin-top: 10px; margin-left: 20px; line-height: 1.8; font-size: 14px;">
                        <li><strong>Host on GitHub Pages</strong> (see GITHUB_HOSTING.md guide)</li>
                        <li><strong>Configure Google Cloud</strong> (see GOOGLE_DRIVE_SETUP.md)</li>
                        <li><strong>Connect ‚Üí Auto-sync!</strong> Desktop saves, mobile loads automatically</li>
                    </ol>
                </div>
            </div>

            <div class="upload-section">
                <h3>üìÅ Manual File Transfer (Backup Method)</h3>
                <p style="color: #aaa; margin-bottom: 20px;">Works immediately without any setup</p>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="exportDatabase()" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
                        üì• Download Database File
                    </button>
                    <button onclick="document.getElementById('import-db-file').click()" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
                        üì§ Import Database File
                    </button>
                </div>

                <input type="file" id="import-db-file" accept=".json" style="display: none;" onchange="importDatabase(this)">
            </div>

            <div class="upload-section">
                <h3>üìà Current Database Status</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-vehicles">0</div>
                        <div class="stat-label">Active Vehicles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="grounded-count">0</div>
                        <div class="stat-label">Grounded Vehicles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="audited-count">0</div>
                        <div class="stat-label">Recently Audited</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Page -->
    <div class="page" id="audit-page">
        <div class="container">
            <div class="header">
                <h2>üîç VSA Audit</h2>
                <div class="header-actions">
                    <button onclick="showPage('upload-page')" class="btn-secondary">Data Management</button>
                    <button onclick="clearAuditSearch()" class="btn-info">Clear Search</button>
                    <button onclick="logout()" class="btn-danger">Logout</button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <h3>‚å®Ô∏è Enter License Plate</h3>
                <div class="autocomplete-wrapper">
                    <input type="text" id="license-plate-input" placeholder="Type license plate (e.g., HB449JJ)..." autocomplete="off">
                    <div id="autocomplete-list"></div>
                </div>
                <button onclick="searchVehicle()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                    üîç Check Vehicle
                </button>
            </div>

            <!-- Vehicle Information -->
            <div class="vehicle-info" id="vehicle-info">
                <h3>üöê Vehicle Information</h3>
                
                <!-- GROUNDED WARNING (shown only if vehicle is grounded) -->
                <div class="grounded-warning" id="grounded-warning" style="display: none;">
                    <div class="grounded-warning-text">
                        üö´ VEHICLE GROUNDED üö´<br>
                        THIS VAN CANNOT GO OUT
                    </div>
                </div>
                
                <div class="info-row">
                    <span class="info-label">License Plate:</span>
                    <span class="info-value" id="info-plate"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">VIN:</span>
                    <span class="info-value" id="info-vin"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">DSP:</span>
                    <span class="info-value" id="info-dsp"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value" id="info-status"></span>
                </div>
                <div class="info-row last-audit-row">
                    <span class="info-label last-audit-label">‚ö†Ô∏è Last Audit:</span>
                    <span class="info-value last-audit-value" id="info-last-audit"></span>
                </div>

                <div class="action-buttons">
                    <button onclick="vanOK()" class="btn-van-ok">‚úÖ VAN OK</button>
                    <button onclick="vsaBlock()" class="btn-vsa-block">‚ùå VSA TO BLOCK</button>
                </div>
            </div>

            <!-- Problem Description -->
            <div class="problem-section" id="problem-section">
                <h3>‚ö†Ô∏è Describe the Problem</h3>
                <textarea id="problem-description" placeholder="Enter the problem details..."></textarea>
                <button onclick="submitProblem()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                    Continue to QR Code
                </button>
            </div>

            <!-- QR Code Section -->
            <div class="qr-section" id="qr-section">
                <h3 id="qr-title">QR Code Generated</h3>
                <div id="qr-code"></div>
                <div class="qr-info" id="qr-info"></div>
                <button onclick="saveAudit()" class="btn btn-success" style="margin-top: 20px;">
                    üíæ Save Audit
                </button>
                <button onclick="clearAuditSearch()" class="btn btn-secondary" style="margin-top: 10px;">
                    üîÑ Check Another Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Download Page -->
    <div class="page" id="download-page">
        <div class="container">
            <div class="header">
                <h2>üìä Reports & Analytics</h2>
                <div class="header-actions">
                    <button onclick="showPage('upload-page')" class="btn-secondary">Data Management</button>
                    <button onclick="showPage('audit-page')" class="btn-primary">Go to Audit</button>
                    <button onclick="logout()" class="btn-danger">Logout</button>
                </div>
            </div>

            <div class="download-section">
                <h3>üìà Audit Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="report-total-audits">0</div>
                        <div class="stat-label">Total Audits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="report-passed">0</div>
                        <div class="stat-label">Passed (OK)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="report-failed">0</div>
                        <div class="stat-label">Failed (Blocked)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="report-today">0</div>
                        <div class="stat-label">Today's Audits</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">üì• Download Reports</h3>
                <div class="download-buttons">
                    <button onclick="downloadAllAudits()" class="btn btn-primary">
                        Download All Audits
                    </button>
                    <button onclick="downloadPassedOnly()" class="btn btn-success">
                        Download Passed Only
                    </button>
                    <button onclick="downloadFailedOnly()" class="btn btn-danger">
                        Download Failed Only
                    </button>
                    <button onclick="clearAllData()" class="btn btn-danger">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>

                <div id="download-status"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            username: 'amazon',
            password: 'vsa2024',
            storageKeys: {
                vehicles: 'vsa_vehicles',
                audits: 'vsa_audits',
                loggedIn: 'vsa_logged_in',
                googleToken: 'vsa_google_token',
                googleUser: 'vsa_google_user'
            },
            googleDrive: {
                clientId: '93183734604-oglk2ci8h5p0tpq8j6kiq96c7b15t34q.apps.googleusercontent.com',
                apiKey: 'AIzaSyCpjOPxMgBp49ETGNwM_eWD3fL-vxLEUsQ',
                scope: 'https://www.googleapis.com/auth/drive.file',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                fileName: 'vsa_database.json',
                mimeType: 'application/json'
            }
        };

        // Global state
        let vehicleDatabase = [];
        let currentVehicle = null;
        let auditResult = null;
        let googleDriveReady = false;
        let googleAccessToken = null;
        let googleDriveFileId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadVehicleData();
            setupEventListeners();
            
            // Wait a bit for Google scripts to load, then initialize
            setTimeout(() => {
                initializeGoogleDrive();
            }, 1000);
        });

        // Google Drive Integration
        async function initializeGoogleDrive() {
            console.log('Initializing Google Drive...');
            
            // Check if credentials are configured (look for placeholder text)
            if (CONFIG.googleDrive.clientId === 'YOUR_CLIENT_ID.apps.googleusercontent.com' || 
                CONFIG.googleDrive.apiKey === 'YOUR_API_KEY') {
                console.log('Google Drive credentials not configured yet.');
                updateGoogleDriveStatus('not_configured');
                return;
            }

            console.log('Google Drive credentials found, checking scripts...');
            
            // Check if Google API scripts loaded
            if (typeof gapi === 'undefined') {
                console.error('GAPI script not loaded! Check internet connection.');
                updateGoogleDriveStatus('error');
                showStatus('sync-status', '‚ùå Google API script failed to load. Check internet connection and refresh page.', 'error');
                return;
            }
            
            if (typeof google === 'undefined' || typeof google.accounts === 'undefined') {
                console.error('Google Identity Services script not loaded!');
                updateGoogleDriveStatus('error');
                showStatus('sync-status', '‚ùå Google Identity script failed to load. Check internet connection and refresh page.', 'error');
                return;
            }
            
            console.log('Scripts loaded successfully, initializing API...');
            
            try {
                await loadGoogleAPI();
                console.log('Google API loaded successfully');
                checkStoredGoogleAuth();
            } catch (error) {
                console.error('Error initializing Google Drive:', error);
                updateGoogleDriveStatus('error');
                showStatus('sync-status', '‚ùå Google Drive initialization error: ' + error.message, 'error');
            }
        }

        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                console.log('Loading gapi.client...');
                
                if (typeof gapi === 'undefined') {
                    reject(new Error('Google API script not loaded. Check internet connection.'));
                    return;
                }
                
                gapi.load('client', async () => {
                    try {
                        console.log('Initializing gapi.client with API Key:', CONFIG.googleDrive.apiKey.substring(0, 10) + '...');
                        
                        await gapi.client.init({
                            apiKey: CONFIG.googleDrive.apiKey,
                            discoveryDocs: CONFIG.googleDrive.discoveryDocs,
                        });
                        
                        console.log('gapi.client initialized successfully');
                        googleDriveReady = true;
                        resolve();
                    } catch (error) {
                        console.error('Error initializing gapi.client:', error);
                        reject(error);
                    }
                });
            });
        }

        function checkStoredGoogleAuth() {
            console.log('Checking for stored Google auth...');
            
            const storedToken = localStorage.getItem(CONFIG.storageKeys.googleToken);
            const storedUser = localStorage.getItem(CONFIG.storageKeys.googleUser);
            
            if (storedToken && storedUser) {
                console.log('Found stored credentials for:', storedUser);
                googleAccessToken = storedToken;
                gapi.client.setToken({ access_token: storedToken });
                updateGoogleDriveStatus('connected', storedUser);
                
                // Auto-load database from Google Drive on mobile
                if (vehicleDatabase.length === 0) {
                    console.log('Database empty, auto-loading from Drive...');
                    autoLoadFromGoogleDrive();
                } else {
                    console.log('Database already loaded locally');
                }
            } else {
                console.log('No stored credentials found');
                updateGoogleDriveStatus('disconnected');
            }
        }

        async function signInToGoogle() {
            console.log('Sign-in initiated...');
            
            if (!googleDriveReady) {
                const error = 'Google Drive not ready. API may not have loaded properly.';
                console.error(error);
                showStatus('sync-status', '‚ö†Ô∏è ' + error, 'error');
                return;
            }

            if (typeof google === 'undefined' || typeof google.accounts === 'undefined') {
                const error = 'Google Identity Services not loaded. Check internet connection.';
                console.error(error);
                showStatus('sync-status', '‚ö†Ô∏è ' + error, 'error');
                return;
            }

            try {
                console.log('Creating token client with Client ID:', CONFIG.googleDrive.clientId.substring(0, 20) + '...');
                
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.googleDrive.clientId,
                    scope: CONFIG.googleDrive.scope,
                    callback: async (response) => {
                        console.log('Auth callback received');
                        
                        if (response.error) {
                            console.error('Auth error:', response);
                            showStatus('sync-status', '‚ùå Google sign-in failed: ' + response.error, 'error');
                            return;
                        }

                        console.log('Access token received');
                        googleAccessToken = response.access_token;
                        gapi.client.setToken({ access_token: googleAccessToken });
                        
                        // Get user info
                        console.log('Getting user info...');
                        const userInfo = await getUserInfo();
                        console.log('User email:', userInfo.email);
                        
                        // Store auth
                        localStorage.setItem(CONFIG.storageKeys.googleToken, googleAccessToken);
                        localStorage.setItem(CONFIG.storageKeys.googleUser, userInfo.email);
                        
                        updateGoogleDriveStatus('connected', userInfo.email);
                        showStatus('sync-status', '‚úÖ Connected to Google Drive as ' + userInfo.email, 'success');
                        
                        // Auto-load if database is empty
                        if (vehicleDatabase.length === 0) {
                            console.log('Database empty, attempting auto-load...');
                            autoLoadFromGoogleDrive();
                        }
                    },
                });

                console.log('Requesting access token...');
                client.requestAccessToken();
            } catch (error) {
                console.error('Sign-in error:', error);
                showStatus('sync-status', '‚ùå Sign-in error: ' + error.message, 'error');
            }
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        Authorization: `Bearer ${googleAccessToken}`
                    }
                });
                return await response.json();
            } catch (error) {
                return { email: 'Unknown' };
            }
        }

        function signOutFromGoogle() {
            localStorage.removeItem(CONFIG.storageKeys.googleToken);
            localStorage.removeItem(CONFIG.storageKeys.googleUser);
            googleAccessToken = null;
            googleDriveFileId = null;
            gapi.client.setToken(null);
            updateGoogleDriveStatus('disconnected');
            showStatus('sync-status', 'Disconnected from Google Drive', 'info');
        }

        function updateGoogleDriveStatus(status, email = '') {
            const statusDiv = document.getElementById('google-drive-status');
            const statusIcon = document.getElementById('gdrive-status-icon');
            const statusText = document.getElementById('gdrive-status-text');
            const userEmail = document.getElementById('gdrive-user-email');
            const signinBtn = document.getElementById('google-signin-btn');
            const signoutBtn = document.getElementById('google-signout-btn');

            statusDiv.style.display = 'flex';

            switch(status) {
                case 'connected':
                    statusDiv.style.background = 'rgba(40, 167, 69, 0.1)';
                    statusDiv.style.border = '1px solid #28a745';
                    statusIcon.textContent = 'üü¢';
                    statusText.textContent = 'Connected to Google Drive';
                    statusText.style.color = '#28a745';
                    userEmail.textContent = email;
                    signinBtn.style.display = 'none';
                    signoutBtn.style.display = 'block';
                    break;
                    
                case 'disconnected':
                    statusDiv.style.background = 'rgba(255, 193, 7, 0.1)';
                    statusDiv.style.border = '1px solid #ffc107';
                    statusIcon.textContent = 'üü°';
                    statusText.textContent = 'Not connected to Google Drive';
                    statusText.style.color = '#ffc107';
                    userEmail.textContent = 'Click "Connect Google Drive" to enable auto-sync';
                    signinBtn.style.display = 'block';
                    signoutBtn.style.display = 'none';
                    break;
                    
                case 'not_configured':
                    statusDiv.style.background = 'rgba(108, 117, 125, 0.1)';
                    statusDiv.style.border = '1px solid #6c757d';
                    statusIcon.textContent = '‚öôÔ∏è';
                    statusText.textContent = 'Google Drive not configured';
                    statusText.style.color = '#6c757d';
                    userEmail.textContent = 'See setup instructions below';
                    signinBtn.style.display = 'none';
                    signoutBtn.style.display = 'none';
                    break;
                    
                case 'error':
                    statusDiv.style.background = 'rgba(220, 53, 69, 0.1)';
                    statusDiv.style.border = '1px solid #dc3545';
                    statusIcon.textContent = 'üî¥';
                    statusText.textContent = 'Error connecting to Google Drive';
                    statusText.style.color = '#dc3545';
                    userEmail.textContent = 'Check console for details';
                    signinBtn.style.display = 'block';
                    signoutBtn.style.display = 'none';
                    break;
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // License plate input with autocomplete
            const input = document.getElementById('license-plate-input');
            input.addEventListener('input', handleAutocomplete);
            input.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchVehicle();
                }
            });
            
            // Auto-clear input when user clicks on it to start typing new plate
            input.addEventListener('focus', function() {
                this.value = '';
                this.placeholder = 'Type license plate (e.g., HB449JJ)...';
                // Hide vehicle info when user focuses to type new plate
                document.getElementById('vehicle-info').classList.remove('show');
                document.getElementById('problem-section').classList.remove('show');
                document.getElementById('qr-section').classList.remove('show');
            });

            // Click outside to close autocomplete
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    document.getElementById('autocomplete-list').style.display = 'none';
                }
            });
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === CONFIG.username && password === CONFIG.password) {
                localStorage.setItem(CONFIG.storageKeys.loggedIn, 'true');
                document.getElementById('login-error').classList.add('hidden');
                showPage('upload-page');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem(CONFIG.storageKeys.loggedIn);
            if (isLoggedIn === 'true') {
                showPage('upload-page');
            } else {
                showPage('login-page');
            }
        }

        function logout() {
            localStorage.removeItem(CONFIG.storageKeys.loggedIn);
            showPage('login-page');
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'upload-page') {
                updateDatabaseStats();
            } else if (pageId === 'download-page') {
                updateReportStats();
            } else if (pageId === 'audit-page') {
                // Don't reset on page show, only when user clicks clear
            }
        }

        // File Upload and Processing
        let uploadedFiles = {
            'dive-deep': null,
            'vin-audit': null,
            'grounded': null
        };

        function handleFileSelect(input, fileType) {
            const file = input.files[0];
            if (file) {
                uploadedFiles[fileType] = file;
                document.getElementById(fileType + '-name').textContent = '‚úì ' + file.name;
            }
        }

        async function processFiles() {
            if (!uploadedFiles['dive-deep'] || !uploadedFiles['vin-audit'] || !uploadedFiles['grounded']) {
                showStatus('upload-status', 'Please upload all three files', 'error');
                return;
            }

            showLoading('Processing files...');

            try {
                // Process Dive Deep CSV
                const diveDeepData = await readCSV(uploadedFiles['dive-deep']);
                
                // Process VIN Audit Excel
                const vinAuditData = await readExcel(uploadedFiles['vin-audit'], 5);
                
                // Process Grounded Excel
                const groundedData = await readExcel(uploadedFiles['grounded'], 2);

                // Build vehicle database
                buildVehicleDatabase(diveDeepData, vinAuditData, groundedData);

                hideLoading();
                showStatus('upload-status', `Successfully processed ${vehicleDatabase.length} vehicles!`, 'success');
                updateDatabaseStats();

            } catch (error) {
                hideLoading();
                showStatus('upload-status', 'Error processing files: ' + error.message, 'error');
                console.error(error);
            }
        }

        function readCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const values = line.split(',');
                            data.push({
                                dsp: values[2],
                                vin: values[4],
                                licensePlate: values[5],
                                status: values[6]
                            });
                        }
                    }
                    resolve(data);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function readExcel(file, skipRows) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                            header: 1,
                            defval: null
                        });
                        
                        // Skip header rows and return data
                        resolve(jsonData.slice(skipRows));
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function buildVehicleDatabase(diveDeep, vinAudit, grounded) {
            vehicleDatabase = [];

            const vinAuditMap = new Map();
            vinAudit.forEach(row => {
                if (row[6]) {
                    vinAuditMap.set(row[6], row[10]);
                }
            });

            const groundedSet = new Set();
            grounded.forEach(row => {
                if (row[6]) {
                    groundedSet.add(row[6]);
                }
            });

            diveDeep.forEach(vehicle => {
                if (vehicle.vin && vehicle.licensePlate) {
                    vehicleDatabase.push({
                        vin: vehicle.vin,
                        licensePlate: vehicle.licensePlate.toUpperCase(),
                        dsp: vehicle.dsp,
                        status: vehicle.status,
                        isGrounded: groundedSet.has(vehicle.vin),
                        lastAudit: vinAuditMap.get(vehicle.vin) || null
                    });
                }
            });

            localStorage.setItem(CONFIG.storageKeys.vehicles, JSON.stringify(vehicleDatabase));
            console.log('Vehicle database built:', vehicleDatabase.length, 'vehicles');

            // Auto-save to Google Drive if connected
            if (googleAccessToken && vehicleDatabase.length > 0) {
                setTimeout(() => {
                    saveToGoogleDrive();
                }, 1000);
            }
        }

        function loadVehicleData() {
            const stored = localStorage.getItem(CONFIG.storageKeys.vehicles);
            if (stored) {
                vehicleDatabase = JSON.parse(stored);
                console.log('Loaded', vehicleDatabase.length, 'vehicles from storage');
            }
        }

        function updateDatabaseStats() {
            document.getElementById('total-vehicles').textContent = vehicleDatabase.length;
            document.getElementById('grounded-count').textContent = 
                vehicleDatabase.filter(v => v.isGrounded).length;
            document.getElementById('audited-count').textContent = 
                vehicleDatabase.filter(v => v.lastAudit).length;
        }

        // Google Drive Save/Load Functions
        async function manualSyncToGoogleDrive() {
            if (!googleAccessToken) {
                showStatus('sync-status', '‚ö†Ô∏è Please connect to Google Drive first', 'error');
                return;
            }

            if (vehicleDatabase.length === 0) {
                showStatus('sync-status', '‚ùå No database to sync. Process files first.', 'error');
                return;
            }

            await saveToGoogleDrive();
        }

        async function saveToGoogleDrive() {
            try {
                showLoading('Saving to Google Drive...');

                const exportData = {
                    vehicles: vehicleDatabase,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const fileContent = JSON.stringify(exportData, null, 2);
                const file = new Blob([fileContent], { type: CONFIG.googleDrive.mimeType });

                // Check if file already exists
                const existingFileId = await findFileInDrive(CONFIG.googleDrive.fileName);

                let response;
                if (existingFileId) {
                    // Update existing file
                    response = await updateFileInDrive(existingFileId, file);
                    googleDriveFileId = existingFileId;
                } else {
                    // Create new file
                    response = await createFileInDrive(file);
                    googleDriveFileId = response.id;
                }

                hideLoading();
                showStatus('sync-status', `‚úÖ Database synced to Google Drive! ${vehicleDatabase.length} vehicles saved.`, 'success');
                return true;
            } catch (error) {
                hideLoading();
                console.error('Error saving to Google Drive:', error);
                showStatus('sync-status', '‚ùå Error saving to Google Drive: ' + error.message, 'error');
                return false;
            }
        }

        async function manualLoadFromGoogleDrive() {
            if (!googleAccessToken) {
                showStatus('sync-status', '‚ö†Ô∏è Please connect to Google Drive first', 'error');
                return;
            }

            await loadFromGoogleDrive();
        }

        async function autoLoadFromGoogleDrive() {
            // Silently try to load database from Google Drive
            try {
                await loadFromGoogleDrive(true);
            } catch (error) {
                console.log('Auto-load from Google Drive failed:', error);
            }
        }

        async function loadFromGoogleDrive(silent = false) {
            try {
                if (!silent) showLoading('Loading from Google Drive...');

                const fileId = await findFileInDrive(CONFIG.googleDrive.fileName);
                
                if (!fileId) {
                    if (!silent) {
                        hideLoading();
                        showStatus('sync-status', '‚ö†Ô∏è No database found in Google Drive. Process files and sync first.', 'info');
                    }
                    return;
                }

                const fileContent = await downloadFileFromDrive(fileId);
                const importData = JSON.parse(fileContent);

                if (!importData.vehicles || !Array.isArray(importData.vehicles)) {
                    throw new Error('Invalid database format');
                }

                vehicleDatabase = importData.vehicles;
                localStorage.setItem(CONFIG.storageKeys.vehicles, JSON.stringify(vehicleDatabase));
                googleDriveFileId = fileId;

                if (!silent) hideLoading();
                updateDatabaseStats();
                showStatus('sync-status', `‚úÖ Database loaded from Google Drive! ${vehicleDatabase.length} vehicles.`, 'success');
            } catch (error) {
                if (!silent) {
                    hideLoading();
                    console.error('Error loading from Google Drive:', error);
                    showStatus('sync-status', '‚ùå Error loading from Google Drive: ' + error.message, 'error');
                }
            }
        }

        async function findFileInDrive(fileName) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }
                return null;
            } catch (error) {
                console.error('Error finding file:', error);
                return null;
            }
        }

        async function createFileInDrive(fileBlob) {
            const metadata = {
                name: CONFIG.googleDrive.fileName,
                mimeType: CONFIG.googleDrive.mimeType
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', fileBlob);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${googleAccessToken}`
                },
                body: form
            });

            return await response.json();
        }

        async function updateFileInDrive(fileId, fileBlob) {
            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    Authorization: `Bearer ${googleAccessToken}`,
                    'Content-Type': CONFIG.googleDrive.mimeType
                },
                body: fileBlob
            });

            return await response.json();
        }

        async function downloadFileFromDrive(fileId) {
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: {
                    Authorization: `Bearer ${googleAccessToken}`
                }
            });

            return await response.text();
        }

        // Export/Import Database
        function exportDatabase() {
            if (vehicleDatabase.length === 0) {
                showStatus('sync-status', 'No database to export. Please upload and process files first.', 'error');
                return;
            }

            const exportData = {
                vehicles: vehicleDatabase,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vsa_database_${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            showStatus('sync-status', `‚úÖ Database exported! ${vehicleDatabase.length} vehicles. Transfer this file to mobile via email, Drive, WhatsApp, etc.`, 'success');
        }

        function importDatabase(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.vehicles || !Array.isArray(importData.vehicles)) {
                        throw new Error('Invalid database format');
                    }

                    vehicleDatabase = importData.vehicles;
                    localStorage.setItem(CONFIG.storageKeys.vehicles, JSON.stringify(vehicleDatabase));
                    
                    updateDatabaseStats();
                    showStatus('sync-status', `‚úÖ Database imported successfully! ${vehicleDatabase.length} vehicles loaded.`, 'success');
                    
                    // Reset the file input
                    input.value = '';
                } catch (error) {
                    showStatus('sync-status', '‚ùå Import failed: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Autocomplete
        function handleAutocomplete() {
            const input = document.getElementById('license-plate-input');
            const value = input.value.toUpperCase();
            const list = document.getElementById('autocomplete-list');

            // Hide vehicle info and related sections when user starts typing again
            if (value.length > 0) {
                document.getElementById('vehicle-info').classList.remove('show');
                document.getElementById('problem-section').classList.remove('show');
                document.getElementById('qr-section').classList.remove('show');
            }

            if (value.length < 2) {
                list.style.display = 'none';
                return;
            }

            const matches = vehicleDatabase.filter(v => 
                v.licensePlate.includes(value)
            ).slice(0, 10);

            if (matches.length === 0) {
                list.style.display = 'none';
                return;
            }

            list.innerHTML = matches.map(v => `
                <div class="autocomplete-item" onclick="selectVehicle('${v.licensePlate}')">
                    <strong>${v.licensePlate}</strong> - ${v.dsp} - VIN: ${v.vin.substr(-6)}
                </div>
            `).join('');

            list.style.display = 'block';
        }

        function selectVehicle(licensePlate) {
            document.getElementById('license-plate-input').value = licensePlate;
            document.getElementById('autocomplete-list').style.display = 'none';
            searchVehicle();
        }

        // Vehicle Search
        function searchVehicle() {
            const plate = document.getElementById('license-plate-input').value.toUpperCase().trim();
            
            if (!plate) {
                alert('Please enter a license plate');
                return;
            }

            const vehicle = vehicleDatabase.find(v => v.licensePlate === plate);

            if (!vehicle) {
                alert('Vehicle not found in database');
                return;
            }

            currentVehicle = vehicle;
            displayVehicleInfo(vehicle);
        }

        function displayVehicleInfo(vehicle) {
            document.getElementById('info-plate').textContent = vehicle.licensePlate;
            document.getElementById('info-vin').textContent = vehicle.vin;
            document.getElementById('info-dsp').textContent = vehicle.dsp;
            
            // Show GROUNDED warning if vehicle is grounded
            const groundedWarning = document.getElementById('grounded-warning');
            if (vehicle.isGrounded) {
                groundedWarning.style.display = 'block';
            } else {
                groundedWarning.style.display = 'none';
            }
            
            let statusHtml = '<span class="status-badge badge-active">ACTIVE</span>';
            if (vehicle.isGrounded) {
                statusHtml = '<span class="status-badge badge-grounded">GROUNDED</span>';
            }
            document.getElementById('info-status').innerHTML = statusHtml;
            
            // Get Last Audit elements
            const lastAuditRow = document.querySelector('.last-audit-row');
            const lastAuditLabel = document.querySelector('.last-audit-label');
            const lastAuditValue = document.getElementById('info-last-audit');
            
            // Remove all styling classes first
            lastAuditRow.classList.remove('needs-vsa', 'already-audited');
            lastAuditLabel.classList.remove('needs-vsa', 'already-audited');
            lastAuditValue.classList.remove('needs-vsa', 'already-audited');
            
            // Apply styling based on audit status
            if (vehicle.lastAudit) {
                // Has audit date - Already audited, show in GREEN
                lastAuditRow.classList.add('already-audited');
                lastAuditLabel.classList.add('already-audited');
                lastAuditValue.classList.add('already-audited');
                lastAuditLabel.innerHTML = '‚úÖ Last Audit:';
                lastAuditValue.textContent = vehicle.lastAudit;
            } else {
                // No audit date - Needs VSA, show in YELLOW with warning
                lastAuditRow.classList.add('needs-vsa');
                lastAuditLabel.classList.add('needs-vsa');
                lastAuditValue.classList.add('needs-vsa');
                lastAuditLabel.innerHTML = '‚ö†Ô∏è Last Audit:';
                lastAuditValue.textContent = 'NOT AUDITED YET - VSA REQUIRED';
            }

            document.getElementById('vehicle-info').classList.add('show');
            
            // Hide autocomplete when vehicle is displayed
            document.getElementById('autocomplete-list').style.display = 'none';
        }

        function clearAuditSearch() {
            currentVehicle = null;
            auditResult = null;
            document.getElementById('license-plate-input').value = '';
            document.getElementById('license-plate-input').focus();
            document.getElementById('problem-description').value = '';
            document.getElementById('vehicle-info').classList.remove('show');
            document.getElementById('problem-section').classList.remove('show');
            document.getElementById('qr-section').classList.remove('show');
            document.getElementById('autocomplete-list').style.display = 'none';
        }

        // Audit Actions
        function vanOK() {
            if (!currentVehicle) return;

            // Reset problem section if it was opened by mistake
            document.getElementById('problem-section').classList.remove('show');
            document.getElementById('problem-description').value = '';

            auditResult = {
                result: 'PASSED',
                problem: null
            };

            generateQRCode();
        }

        function vsaBlock() {
            if (!currentVehicle) return;

            document.getElementById('problem-section').classList.add('show');
            document.getElementById('qr-section').classList.remove('show');
        }

        function submitProblem() {
            const problem = document.getElementById('problem-description').value.trim();
            
            if (!problem) {
                alert('Please describe the problem');
                return;
            }

            auditResult = {
                result: 'FAILED',
                problem: problem
            };

            document.getElementById('problem-section').classList.remove('show');
            generateQRCode();
        }

        function generateQRCode() {
            const qrDiv = document.getElementById('qr-code');
            qrDiv.innerHTML = '';

            const qrData = JSON.stringify({
                vin: currentVehicle.vin,
                licensePlate: currentVehicle.licensePlate,
                dsp: currentVehicle.dsp,
                result: auditResult.result,
                problem: auditResult.problem,
                timestamp: new Date().toISOString()
            });

            new QRCode(qrDiv, {
                text: qrData,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            const title = auditResult.result === 'PASSED' ? 
                '‚úÖ Van OK - QR Code' : 
                '‚ùå VSA Blocked - QR Code';
            
            document.getElementById('qr-title').textContent = title;
            document.getElementById('qr-info').innerHTML = `
                VIN: ${currentVehicle.vin}<br>
                License Plate: ${currentVehicle.licensePlate}<br>
                DSP: ${currentVehicle.dsp}<br>
                Result: ${auditResult.result}
            `;

            document.getElementById('qr-section').classList.add('show');
        }

        function saveAudit() {
            if (!currentVehicle || !auditResult) return;

            const audit = {
                id: Date.now(),
                vin: currentVehicle.vin,
                licensePlate: currentVehicle.licensePlate,
                dsp: currentVehicle.dsp,
                result: auditResult.result,
                problem: auditResult.problem,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            // Load existing audits
            const audits = JSON.parse(localStorage.getItem(CONFIG.storageKeys.audits) || '[]');
            audits.push(audit);
            localStorage.setItem(CONFIG.storageKeys.audits, JSON.stringify(audits));

            alert('‚úÖ Audit saved successfully!');
            
            // Auto clear after save for next vehicle
            setTimeout(() => {
                clearAuditSearch();
            }, 500);
        }

        // Reports and Downloads
        function updateReportStats() {
            const audits = JSON.parse(localStorage.getItem(CONFIG.storageKeys.audits) || '[]');
            const today = new Date().toLocaleDateString();

            document.getElementById('report-total-audits').textContent = audits.length;
            document.getElementById('report-passed').textContent = 
                audits.filter(a => a.result === 'PASSED').length;
            document.getElementById('report-failed').textContent = 
                audits.filter(a => a.result === 'FAILED').length;
            document.getElementById('report-today').textContent = 
                audits.filter(a => a.date === today).length;
        }

        function downloadAllAudits() {
            downloadAudits('all');
        }

        function downloadPassedOnly() {
            downloadAudits('passed');
        }

        function downloadFailedOnly() {
            downloadAudits('failed');
        }

        function downloadAudits(type) {
            let audits = JSON.parse(localStorage.getItem(CONFIG.storageKeys.audits) || '[]');

            if (type === 'passed') {
                audits = audits.filter(a => a.result === 'PASSED');
            } else if (type === 'failed') {
                audits = audits.filter(a => a.result === 'FAILED');
            }

            if (audits.length === 0) {
                alert('No audits to download');
                return;
            }

            // Create CSV
            const headers = ['ID', 'Date', 'Time', 'License Plate', 'VIN', 'DSP', 'Result', 'Problem'];
            const rows = audits.map(a => [
                a.id,
                a.date,
                a.time,
                a.licensePlate,
                a.vin,
                a.dsp,
                a.result,
                a.problem || ''
            ]);

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vsa_audits_${type}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            showStatus('download-status', `Downloaded ${audits.length} audit records`, 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL audit data? This cannot be undone.')) {
                if (confirm('This will delete all audit history. Are you absolutely sure?')) {
                    localStorage.removeItem(CONFIG.storageKeys.audits);
                    updateReportStats();
                    showStatus('download-status', 'All audit data cleared', 'info');
                }
            }
        }

        // Utility Functions
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = 'status-message status-' + type;
            element.textContent = message;
            element.style.display = 'block';
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }
    </script>
</body>
</html>
